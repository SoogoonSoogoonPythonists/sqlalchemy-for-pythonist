<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Manipulating Data Using ORM | SQLAlchemy for Python Developers</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-SNPCYHY4R2"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SNPCYHY4R2');</script>
    <meta name="description" content="This is a document that simplifies SQLAlchemy for easy understanding.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="google-site-verification" content="wjX_mSoZBgO9SZMvjr96yOjo6n3_7pS8xNdmzDl1ESw">
    
    <link rel="preload" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css" as="style"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/18.760e3a59.js" as="script"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/10.e7fb4c80.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/11.051ae6e1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/12.7b93e986.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/13.8d014a70.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/14.138cd924.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/15.dca0d300.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/16.69771a0f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/17.66ba2d35.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/19.7b4a8a4e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/20.adec2767.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/21.c59b443d.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/22.f84628fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/23.2c4a7cf3.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/24.7785bb30.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/25.dc95a31e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/26.a287ef6a.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/27.a111ddcb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/28.b809fce0.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/29.7029d8fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/3.2e213720.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/30.b93101cb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/31.363734c1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/4.51c0545f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/5.220df36c.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/6.345e52dd.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/7.a15a95f4.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/8.006f2d84.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/9.7948c093.js">
    <link rel="stylesheet" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqlalchemy-for-pythonist/en/" class="home-link router-link-active"><!----> <span class="site-name">SQLAlchemy for Python Developers</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/sqlalchemy-for-pythonist/en/tutorial/" class="sidebar-heading clickable router-link-active open"><span>Tutorial</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/sqlalchemy-for-pythonist/en/tutorial/1. Tutorial Overview.html" class="sidebar-link">Tutorial Overview</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/2. Setting Up a Connection.html" class="sidebar-link">Setting up a Connection</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/3. Executing Transactions and Queries.html" class="sidebar-link">Executing Transactions and Queries</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/4. Working with Database Metadata.html" class="sidebar-link">Working with Database Metadata</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.1. Querying Rows Using Core and ORM.html" class="sidebar-link">Querying Rows Using Core and ORM</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.2. Inserting Rows Using Core.html" class="sidebar-link">Inserting Rows Using Core</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.3. Modifying and Deleting Rows Using Core.html" class="sidebar-link">Modifying and Deleting Rows Using Core</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html" class="active sidebar-link">Manipulating Data Using ORM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#inserting-rows-with-orm" class="sidebar-link">Inserting rows with ORM</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#how-to-update-orm-objects" class="sidebar-link">How to UPDATE ORM objects</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#how-to-delete-orm-objects" class="sidebar-link">How to Delete ORM objects</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#rolling-back" class="sidebar-link">Rolling Back</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#closing-the-session" class="sidebar-link">Closing the Session</a></li></ul></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html" class="sidebar-link">Working with Related Objects Using ORM</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="manipulating-data-using-orm"><a href="#manipulating-data-using-orm" class="header-anchor">#</a> Manipulating Data Using ORM</h1> <p>Until the previous chapter, we focused on utilizing queries from the <code>CORE</code> perspective.</p> <p>In this chapter, we explain the components, lifecycle, and interaction methods of the <code>Session</code> used in the ORM approach.</p> <br> <h2 id="inserting-rows-with-orm"><a href="#inserting-rows-with-orm" class="header-anchor">#</a> Inserting rows with ORM</h2> <p>The <code>Session</code> object, when using ORM, creates Insert objects and emits them in transactions. <code>Session</code> adds object entries to perform these processes. Then, through a process called <code>flush</code>, it records the new items in the database.</p> <h3 id="instances-of-objects-representing-rows"><a href="#instances-of-objects-representing-rows" class="header-anchor">#</a> Instances of Objects Representing Rows</h3> <p>In the previous process, we executed INSERT using a Python Dictionary.</p> <p>In ORM, we directly use user-defined Python objects defined in the table metadata definition.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;squidward&quot;</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">&quot;Squidward Tentacles&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> krabs <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;ehkrabs&quot;</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">&quot;Eugene H. Krabs&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>We create two <code>User</code> objects that represent potential database rows to be INSERTed. Because of <code>__init__()</code> constructor automatically created by ORM mapping, we can create each object using the constructor's column names as keys.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'squidward'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Squidward Tentacles'</span><span class="token punctuation">)</span>
</code></pre></div><p>Similar to Core's <code>Insert</code>, ORM integrates it even without including a primary key. The <code>None</code> value for <code>id</code> is provided by SQLAlchemy to indicate that the attribute does not have a value yet.</p> <p>Currently, the two objects (<code>squiward</code> and <code>krabs</code>) are in a state called <code>transient</code>. The <code>transient</code> state means they are not yet connected to any database and not yet associated with a <code>Session</code> object that can generate an <code>INSERT</code> statement.</p> <h3 id="adding-objects-to-the-session"><a href="#adding-objects-to-the-session" class="header-anchor">#</a> Adding Objects to the <code>Session</code></h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session <span class="token operator">=</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>   <span class="token comment"># It is essential to close after use.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>squidward<span class="token punctuation">)</span>      <span class="token comment"># Insert an object into session via Session.add() method.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>krabs<span class="token punctuation">)</span>
</code></pre></div><p>When an object is added to the <code>Session</code> through <code>Session.add()</code>, it is called being in the <code>pending</code> state.
The pending state means the object has not yet been added to the database.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>new   <span class="token comment"># You can check the objects in the pending state through session.new. Objects are added to the Session using the Session.add() method.</span>
IdentitySet<span class="token punctuation">(</span><span class="token punctuation">[</span>User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'squidward'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Squidward Tentacles'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'ehkrabs'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Eugene H. Krabs'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>IdentitySet</code> is a Python set that hashes object IDs in all cases.</li> <li>That is, it uses the <code>id()</code> method, not the <code>hash()</code> function of Python's built-in functions.&quot;</li></ul> <h3 id="flushing"><a href="#flushing" class="header-anchor">#</a> Flushing</h3> <p>The <code>Session</code> object uses the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" target="_blank" rel="noopener noreferrer">unit of work pattern<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This means that it accumulates changes but does not actually communicate with the database until necessary.
This behavior allows objects in the previously mentioned <code>pending</code> state to be used more efficiently in SQL DML.
The process of actually sending the current changes to the Database via SQL is called flushing.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
INSERT INTO user_account (name, fullname) VALUES (?, ?)
[...] ('squidward', 'Squidward Tentacles')
INSERT INTO user_account (name, fullname) VALUES (?, ?)
[...] ('ehkrabs', 'Eugene H. Krabs')
&quot;&quot;&quot;</span>
</code></pre></div><p>Now, the transaction remains open until one of <code>Session.commit()</code>, <code>Session.rollback()</code>, or <code>Session.close()</code> is invoked.</p> <p>While you can use <code>Session.flush()</code> directly to push the current pending contents, <code>Session</code> typically features <code>autoflush</code>, so this is usually not necessary. <code>Session.commit()</code> flushes changes every time it is called.</p> <h3 id="automatically-generated-primary-key-properties"><a href="#automatically-generated-primary-key-properties" class="header-anchor">#</a> Automatically Generated Primary Key Properties</h3> <p>When a row is inserted, the Python object we created becomes <code>persistent</code>.
The <code>persistent</code> state is associated with the loaded <code>Session</code> object.</p> <p>During <code>INSERT</code>, the ORM retrieves the primary key identifier for each new object.
This uses the same <code>CursorResult.inserted_primary_key</code> accessor introduced earlier.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">4</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> krabs<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">5</span>
</code></pre></div><blockquote><p>When ORM is flushed, instead of <code>executemany</code>, two separate INSERT statements are used because of this <code>CursorResult.inserted_primary_key</code>.
In SQLite, for instance, you need to <code>INSERT</code> one column at a time to use the auto-increment feature (other various databases like PostgreSQL's IDENTITY or SERIAL function similarly).
If a database connection like <code>psycopg2</code>, which can provide primary key information for many rows at once, is used, the ORM optimizes this to <code>INSERT</code> many rows at once.&quot;</p></blockquote> <h3 id="identity-map"><a href="#identity-map" class="header-anchor">#</a> Identity Map</h3> <p><code>Identity Map</code> (<code>ID Map</code>) is an in-memory storage that links all objects currently loaded in memory to their primary key IDs. You can retrieve one of these objects through <code>Session.get()</code>. This method searches for the object in the <code>ID Map</code> if it's in memory, or through a <code>SELECT</code> statement if it's not.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> some_squidward <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> some_squidward
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'squidward'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Squidward Tentacles'</span><span class="token punctuation">)</span>
</code></pre></div><p>An important point is that the <code>ID Map</code> maintains unique objects among Python objects.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> some_squidward <span class="token keyword">is</span> squidward 
<span class="token boolean">True</span>
</code></pre></div><p>The <code>ID Map</code> is a crucial feature that allows manipulation of complex object sets within a transaction in an unsynchronized state.</p> <h3 id="committing"><a href="#committing" class="header-anchor">#</a> Committing</h3> <p>We now <code>commit</code> the current changes to the transaction.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
COMMIT
</code></pre></div><br> <h2 id="how-to-update-orm-objects"><a href="#how-to-update-orm-objects" class="header-anchor">#</a> How to UPDATE ORM objects</h2> <p>There are two ways to perform an <code>UPDATE</code> through ORM:</p> <ol><li>Using the <code>unit of work</code> pattern employed by <code>Session</code>. <code>UPDATE</code> operations for each primary key with changes are sent out in sequence.</li> <li>Known as &quot;ORM usage update&quot;, where you can explicitly use the <code>Update</code> construct with Session.&quot;</li></ol> <h3 id="updating-changes-automatically"><a href="#updating-changes-automatically" class="header-anchor">#</a> Updating changes automatically</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;sandy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar_one<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = ?
[...] ('sandy',)
&quot;&quot;&quot;</span>
</code></pre></div><p>This 'Sandy' user object acts as a <em>proxy</em> for a row in the database, more specifically, for the row with primary key <code>2</code> from the transaction's perspective.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy<span class="token punctuation">.</span>fullname <span class="token operator">=</span> <span class="token string">&quot;Sandy Squirrel&quot;</span>   <span class="token comment"># When an object's attribute is changed, the Session records this change.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy <span class="token keyword">in</span> session<span class="token punctuation">.</span>dirty              <span class="token comment"># Such changed objects are referred to as 'dirty' and can be checked in session.dirty.</span>
<span class="token boolean">True</span>
</code></pre></div><p>When the <code>Session</code> executes <code>flush</code>, an <code>UPDATE</code> is executed in the database, actually updating the values in the database. If a <code>SELECT</code> statement is executed afterwards, a <code>flush</code> is automatically executed, allowing you to immediately retrieve the updated name value of Sandy through <code>SELECT</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy_fullname <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>scalar_one<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
UPDATE user_account SET fullname=? WHERE user_account.id = ?
[...] ('Sandy Squirrel', 2)
SELECT user_account.fullname
FROM user_account
WHERE user_account.id = ?
[...] (2,)
&quot;&quot;&quot;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>sandy_fullname<span class="token punctuation">)</span>
Sandy Squirrel
<span class="token comment"># Using the flush, Sandy's changes are actually reflected in the database,</span>
<span class="token comment"># causing the object to lose its 'dirty' status.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy <span class="token keyword">in</span> session<span class="token punctuation">.</span>dirty 
<span class="token boolean">False</span>
</code></pre></div><h3 id="orm-usage-update"><a href="#orm-usage-update" class="header-anchor">#</a> ORM usage update</h3> <p>The last method to perform an <code>UPDATE</code> through ORM is to explicitly use 'ORM usage update'. This allows you to use a general SQL <code>UPDATE</code> statement that can affect many rows at once.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     update<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;sandy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     values<span class="token punctuation">(</span>fullname<span class="token operator">=</span><span class="token string">&quot;Sandy Squirrel Extraordinaire&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
UPDATE user_account SET fullname=? WHERE user_account.name = ?
[...] ('Sandy Squirrel Extraordinaire', 'sandy')
&quot;&quot;&quot;</span>
<span class="token operator">&lt;</span>sqlalchemy<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>CursorResult <span class="token builtin">object</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span>
</code></pre></div><p>If there are objects in the current <code>Session</code> that match the given conditions, the corresponding <code>update</code> will also be reflected in these objects.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy<span class="token punctuation">.</span>fullname
<span class="token string">'Sandy Squirrel Extraordinaire'</span>
</code></pre></div><br> <h2 id="how-to-delete-orm-objects"><a href="#how-to-delete-orm-objects" class="header-anchor">#</a> How to Delete ORM objects</h2> <p>You can mark individual ORM objects for deletion using the <code>Session.delete()</code> method. Once <code>delete</code> is executed, objects in that <code>Session</code> become expired.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> patrick <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id AS user_account_id, user_account.name AS user_account_name,
user_account.fullname AS user_account_fullname
FROM user_account
WHERE user_account.id = ?
[...] (3,)
&quot;&quot;&quot;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>patrick<span class="token punctuation">)</span>     <span class="token comment"># Indicate that patrick will be deleted</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;patrick&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment"># Execute flush at this point</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.id AS address_id, address.email_address AS address_email_address,
address.user_id AS address_user_id
FROM address
WHERE ? = address.user_id
[...] (3,)
DELETE FROM user_account WHERE user_account.id = ?
[...] (3,)
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = ?
[...] ('patrick',)
&quot;&quot;&quot;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward <span class="token keyword">in</span> session <span class="token comment"># Once expired in the Session, the object is removed from the session.</span>
<span class="token boolean">False</span>
</code></pre></div><p>Like the 'Sandy' used in the above <code>UPDATE</code>, these actions are only within the ongoing transaction and can be undone at any time unless <em>committed</em>.</p> <h3 id="orm-usage-delete"><a href="#orm-usage-delete" class="header-anchor">#</a> ORM usage delete</h3> <p>Like <code>UPDATE</code>, there is also 'ORM usage delete'.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># This is just an example, not a necessary operation for delete.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id AS user_account_id, user_account.name AS user_account_name,
user_account.fullname AS user_account_fullname
FROM user_account
WHERE user_account.id = ?
[...] (4,)
&quot;&quot;&quot;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>delete<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;squidward&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
DELETE FROM user_account WHERE user_account.name = ?
[...] ('squidward',)
&lt;sqlalchemy.engine.cursor.CursorResult object at 0x...&gt;
&quot;&quot;&quot;</span>
</code></pre></div><br> <h2 id="rolling-back"><a href="#rolling-back" class="header-anchor">#</a> Rolling Back</h2> <p><code>Session</code> has a <code>Session.rollback()</code> method to roll back the current operations. This method affects Python objects like the aforementioned <code>sandy</code>.
Calling <code>Session.rollback()</code> not only rolls back the transaction but also turns all objects associated with this <code>Session</code> into <code>expired</code> status. This state change triggers a self-refresh the next time the object is accessed, a process known as <em>lazy loading</em>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
ROLLBACK
</code></pre></div><p>Looking closely at <code>sandy</code>, which is in the <code>expired</code> state, you can see that no other information remains except for special SQLAlchemy-related status objects.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy<span class="token punctuation">.</span>__dict__
<span class="token punctuation">{</span><span class="token string">'_sa_instance_state'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>state<span class="token punctuation">.</span>InstanceState <span class="token builtin">object</span> at 0x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy<span class="token punctuation">.</span>fullname      <span class="token comment"># Since the session is expired, accessing the object properties will trigger a new transaction.</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id AS user_account_id, user_account.name AS user_account_name,
user_account.fullname AS user_account_fullname
FROM user_account
WHERE user_account.id = ?
[...] (2,)
&quot;&quot;&quot;</span>
<span class="token string">'Sandy Cheeks'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sandy<span class="token punctuation">.</span>__dict__    <span class="token comment"># Now you can see that the database row is also filled in the sandy object.</span>
<span class="token punctuation">{</span><span class="token string">'_sa_instance_state'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>state<span class="token punctuation">.</span>InstanceState <span class="token builtin">object</span> at 0x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'fullname'</span><span class="token punctuation">:</span> <span class="token string">'Sandy Cheeks'</span><span class="token punctuation">}</span>
</code></pre></div><p>For the deleted objects, you can see that they are restored in the <code>Session</code> and appear again in the database.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> patrick <span class="token keyword">in</span> session
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'patrick'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar_one<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> patrick
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = ?
[...] ('patrick',)
&quot;&quot;&quot;</span>
<span class="token boolean">True</span>
</code></pre></div><br> <h2 id="closing-the-session"><a href="#closing-the-session" class="header-anchor">#</a> Closing the <code>Session</code></h2> <p>We have handled the <code>Session</code> outside of the context structure, and in such cases, it is good practice to <em>explicitly</em> close the <code>Session</code> as follows:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
ROLLBACK
</code></pre></div><p>Similarly, when a <code>Session</code> created through a context statement is closed within the context statement, the following actions are performed.</p> <ul><li>Cancel all ongoing transactions (e.g., rollbacks) to release all connection resources to the connection pool.
<ul><li>This means you don't need to explicitly call <code>Session.rollback()</code> to check if the transaction was rolled back when closing the <code>Session</code> after performing some read-only operations with it. The connection pool handles this.</li></ul></li> <li>Remove all objects from the <code>Session</code>.
<ul><li>This means that all Python objects loaded for this Session, such as <code>sandy</code>, <code>patrick</code>, and <code>squidward</code>, are now in a <code>detached</code> state. For instance, an object that was in the <code>expired</code> state is no longer associated with a database transaction to refresh data due to a <code>Session.commit()</code> call, and it does not contain the current row's state.</li> <li><div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward<span class="token punctuation">.</span>name
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>exc<span class="token punctuation">.</span>DetachedInstanceError<span class="token punctuation">:</span> Instance <span class="token operator">&lt;</span>User at 0x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token keyword">is</span> <span class="token keyword">not</span> bound to a Session<span class="token punctuation">;</span> attribute refresh operation cannot proceed
</code></pre></div></li> <li>Detached objects can be reassociated with the same or a new <code>Session</code> using the <code>Session.add()</code> method, re-establishing the relationship with a specific database row.</li> <li><div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>squidward<span class="token punctuation">)</span>    <span class="token comment"># Reconnect to the session</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> squidward<span class="token punctuation">.</span>name            <span class="token comment"># Retrieve the information through the transaction again.</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id AS user_account_id, user_account.name AS user_account_name, user_account.fullname AS user_account_fullname
FROM user_account
WHERE user_account.id = ?
[...] (4,)
&quot;&quot;&quot;</span>
<span class="token string">'squidward'</span>
</code></pre></div></li></ul></li></ul> <blockquote><p>Objects in the <code>detached</code> state should ideally be avoided. When a <code>Session</code> is closed, it cleans up references to all previously connected objects. Typically, the need for <code>detached</code> objects arises in web applications when an object has just been committed and the <code>Session</code> is closed before it is rendered in a view. In this case, set the <code>Session.expire_on_commit</code> flag to <code>False</code>.</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqlalchemy-for-pythonist/en/tutorial/5.3. Modifying and Deleting Rows Using Core.html" class="prev">
        Modifying and Deleting Rows Using Core
      </a></span> <span class="next"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html">
        Working with Related Objects Using ORM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/18.760e3a59.js" defer></script>
  </body>
</html>
