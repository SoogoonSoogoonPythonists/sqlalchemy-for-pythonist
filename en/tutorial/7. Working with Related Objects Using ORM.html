<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working with Related Objects Using ORM | SQLAlchemy for Python Developers</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-SNPCYHY4R2"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SNPCYHY4R2');</script>
    <meta name="description" content="This is a document that simplifies SQLAlchemy for easy understanding.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="google-site-verification" content="wjX_mSoZBgO9SZMvjr96yOjo6n3_7pS8xNdmzDl1ESw">
    
    <link rel="preload" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css" as="style"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/19.7b4a8a4e.js" as="script"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/10.e7fb4c80.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/11.051ae6e1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/12.7b93e986.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/13.8d014a70.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/14.138cd924.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/15.dca0d300.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/16.69771a0f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/17.66ba2d35.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/18.760e3a59.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/20.adec2767.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/21.c59b443d.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/22.f84628fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/23.2c4a7cf3.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/24.7785bb30.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/25.dc95a31e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/26.a287ef6a.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/27.a111ddcb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/28.b809fce0.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/29.7029d8fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/3.2e213720.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/30.b93101cb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/31.363734c1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/4.51c0545f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/5.220df36c.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/6.345e52dd.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/7.a15a95f4.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/8.006f2d84.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/9.7948c093.js">
    <link rel="stylesheet" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqlalchemy-for-pythonist/en/" class="home-link router-link-active"><!----> <span class="site-name">SQLAlchemy for Python Developers</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/sqlalchemy-for-pythonist/en/tutorial/" class="sidebar-heading clickable router-link-active open"><span>Tutorial</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/sqlalchemy-for-pythonist/en/tutorial/1. Tutorial Overview.html" class="sidebar-link">Tutorial Overview</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/2. Setting Up a Connection.html" class="sidebar-link">Setting up a Connection</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/3. Executing Transactions and Queries.html" class="sidebar-link">Executing Transactions and Queries</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/4. Working with Database Metadata.html" class="sidebar-link">Working with Database Metadata</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.1. Querying Rows Using Core and ORM.html" class="sidebar-link">Querying Rows Using Core and ORM</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.2. Inserting Rows Using Core.html" class="sidebar-link">Inserting Rows Using Core</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/5.3. Modifying and Deleting Rows Using Core.html" class="sidebar-link">Modifying and Deleting Rows Using Core</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html" class="sidebar-link">Manipulating Data Using ORM</a></li><li><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html" class="active sidebar-link">Working with Related Objects Using ORM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html#using-related-objects" class="sidebar-link">Using Related Objects</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html#cascading-objects-in-the-session" class="sidebar-link">Cascading Objects in the Session</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html#loading-relationships" class="sidebar-link">Loading Relationships</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html#using-relationship-in-queries" class="sidebar-link">Using relationship in Queries</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/en/tutorial/7. Working with Related Objects Using ORM.html#types-of-relationship-loading" class="sidebar-link">Types of Relationship Loading</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="working-with-related-objects-using-orm"><a href="#working-with-related-objects-using-orm" class="header-anchor">#</a> Working with Related Objects Using ORM</h1> <br> <p>In this chapter, we will cover another essential ORM concept, which is the interaction with mapped objects that reference other objects.</p> <p><code>relationship()</code> defines the relationship between two mapped objects and is also known as <strong>self-referencing</strong>.</p> <p>For simplicity, we will omit <code>Column</code> mappings and other directives, and explain <code>relationship()</code> in a shortened form.</p> <br> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    <span class="token comment"># ... Column mappings</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>

    <span class="token comment"># ... Column mappings</span>

    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;addresses&quot;</span><span class="token punctuation">)</span>
</code></pre></div><br> <p>In the structure shown, the <code>User</code> object has a variable <code>addresses</code>, and the <code>Address</code> object has a variable <code>user</code>.</p> <p>Both are created as relationship objects, but these aren't <strong>actual database columns</strong> but are set up to allow <strong>easy access</strong> in the code.</p> <p>In other words, it facilitates easy navigation from a <code>User</code> object to an <code>Address</code> object.</p> <p>Additionally, the <code>back_populates</code> parameter in the <code>relationship</code> declaration allows for the reverse situation, i.e., navigating from an <code>Address</code> object to a <code>User</code> object.</p> <blockquote><p>In relational Database terms, it naturally sets a 1 : N relationship as an N : 1 relationship.</p></blockquote> <p>In the next section, we will see what role the <code>relationship()</code> object's instances play and how they function.</p> <br> <h2 id="using-related-objects"><a href="#using-related-objects" class="header-anchor">#</a> Using Related Objects</h2> <br> <p>When a new <code>User</code> object is created, the <code>.addresses</code> collection appears as a <code>List</code> object.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>    
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>You can add an <code>Address</code> object using <code>list.append()</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1 <span class="token operator">=</span> Address<span class="token punctuation">(</span>email_address<span class="token operator">=</span><span class="token string">&quot;pear1.krabs@gmail.com&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a1<span class="token punctuation">)</span>

<span class="token comment"># The u1.addresses collection now includes the new Address object.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>If an <code>Address</code> object is associated with the <code>User.addresses</code> collection, another action occurs in the variable <code>u1</code>. The User.addresses and Address.user relationship is synchronized, allowing you to move:
- From a <code>User</code> object to an <code>Address</code>, and
- Back from an <code>Address</code> object to a <code>User</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1<span class="token punctuation">.</span>user
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>
</code></pre></div><p>This is the result of synchronization using <code>relationship.back_populates</code> between the two <code>relationship()</code> objects.</p> <p>The <code>relationship()</code> parameter can be complementarily assigned/list modified to another variable. Creating another <code>Address</code> object and assigning it to the <code>Address.user</code> property makes it part of the <code>User.addresses</code> collection.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2 <span class="token operator">=</span> Address<span class="token punctuation">(</span>email_address<span class="token operator">=</span><span class="token string">&quot;pearl@aol.com&quot;</span><span class="token punctuation">,</span> user<span class="token operator">=</span>u1<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <p>We actually used the variable <code>u1</code> as a keyword argument for <code>user</code> as if it were a property declared in the object (<code>Address</code>). It's equivalent to assigning the property afterward.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># equivalent effect as a2 = Address(user=u1)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2<span class="token punctuation">.</span>user <span class="token operator">=</span> u1
</code></pre></div><br> <h2 id="cascading-objects-in-the-session"><a href="#cascading-objects-in-the-session" class="header-anchor">#</a> Cascading Objects in the <code>Session</code></h2> <br> <p>We now have two related <code>User</code> and <code>Address</code> objects in a bidirectional structure in memory, but as mentioned earlier in <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html#inserting-rows-with-orm)">Inserting Rows with ORM</a> , these objects are in a <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/glossary.html#term-transient)">transient</a> state in the <code>Session</code> until they are associated with it.</p> <p>We need to see when using <code>Session.add()</code>, and applying the method to the <code>User</code> object, that the related <code>Address</code> objects are also added.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u1<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1 <span class="token keyword">in</span> session
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1 <span class="token keyword">in</span> session
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2 <span class="token keyword">in</span> session 
<span class="token boolean">True</span>
</code></pre></div><p>The three objects are now in a <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/glossary.html#term-pending)">pending</a> state, which means no <code>INSERT</code> operations have been executed yet. The three objects have not been assigned primary keys, and the <code>a1</code> and <code>a2</code> objects have a column (<code>user_id</code>) reference property. This is because the objects are not yet actually connected to a real database.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>u1<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token boolean">None</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token boolean">None</span>
</code></pre></div><p>Let's save it to the database.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>If we translate the implemented code into SQL queries, it would look like this.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_account <span class="token punctuation">(</span>name<span class="token punctuation">,</span> fullname<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> <span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> address <span class="token punctuation">(</span>email_address<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> address <span class="token punctuation">(</span>email_address<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">COMMIT</span>
</code></pre></div><p>Using session, you can automate SQL <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code> statements.</p> <p>Finally, executing <code>Session.commit()</code> ensures all steps are called in the correct order, and the primary key of <code>address.user_id</code> is applied in the <code>user_account</code>.</p> <br> <h2 id="loading-relationships"><a href="#loading-relationships" class="header-anchor">#</a> Loading Relationships</h2> <br> <p>After calling <code>Session.commit()</code>, you can see the primary key created for the <code>u1</code> object.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">6</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">BEGIN</span> <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id <span class="token keyword">AS</span> user_account_id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name <span class="token keyword">AS</span> user_account_name<span class="token punctuation">,</span>
user_account<span class="token punctuation">.</span>fullname <span class="token keyword">AS</span> user_account_fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> ?
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>You can also see that <code>id</code>s are now present in the objects linked to <code>u1.addresses</code>.</p> <p>To retrieve these objects, we can observe the <strong>lazy load</strong> approach.</p> <blockquote><p>lazy loading : This is a method where a SELECT statement is executed to fetch information only when someone tries to access that information. In other words, it retrieves the necessary information as needed.</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> ? <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>SQLAlchemy ORM’s default for collections and related properties is <strong>lazy loading</strong>. This means once a collection has been <em>relationshipped</em>, as long as the data exists in memory, it remains accessible.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>Although lazy loading can be costly without explicit steps for optimization, it is optimized at least not to perform redundant operations.</p> <p>You can also see the <code>a1</code> and <code>a2</code> objects in the <code>u1.addresses</code> collection.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1
Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2
Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span>
</code></pre></div><p>We will provide a further introduction to the concept of <code>relationship</code> in the latter part of this section.</p> <br> <h2 id="using-relationship-in-queries"><a href="#using-relationship-in-queries" class="header-anchor">#</a> Using <code>relationship</code> in Queries</h2> <br> <p>This section introduces several ways in which <code>relationship()</code> helps automate SQL query construction.</p> <br> <h3 id="join-tables-using-relationship"><a href="#join-tables-using-relationship" class="header-anchor">#</a> JOIN tables using <code>relationship()</code></h3> <p>In <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#from절과-join-명시하기)">Specifying the FROM and JOIN Clauses</a> and <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#where절)">WHERE Clauses</a> sections, we used <code>Select.join()</code> and <code>Select.join_from()</code> methods to construct SQL JOINs. These methods infer the ON clause based on whether there's a <code>ForeignKeyConstraint</code> object linking the two tables or provide specific SQL Expression syntax representing the <code>ON</code> clause.</p> <p><code>relationship()</code> objects can be used to set the <code>ON</code> clause for joins.
A <code>relationship()</code> corresponding object can be passed as a <strong>single argument</strong> to <code>Select.join()</code>, serving as both the right join and the ON clause.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select_from<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> user_account <span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><p>If <code>relationship()</code> is not specified in <code>Select.join()</code> or <code>Select.join_from()</code>, <strong>no ON clause is used</strong>. This means it functions due to the <code>ForeignKeyConstraint</code> between the two mapped table objects, not because of the <code>relationship()</code> object of <code>User</code> and <code>Address</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> Address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> user_account <span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h3 id="joining-using-aliases-aliased"><a href="#joining-using-aliases-aliased" class="header-anchor">#</a> Joining Using Aliases(<code>aliased</code>)</h3> <p>When configuring SQL JOINs using <code>relationship()</code>, it's suitable to use [PropComparator.of_type()] with <code>aliased()</code> cases. However, <code>relationship()</code> is used to configure the same joins as described in [<code>ORM Entity Aliases</code>].</p> <p>You can directly use <code>aliased()</code> in a join with <code>relationship()</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> aliased
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_alias_1 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_alias_2 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_1<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_1<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_2<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_2<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@gmail.com'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">JOIN</span> address <span class="token keyword">AS</span> address_1 <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address_1<span class="token punctuation">.</span>user_id
<span class="token keyword">JOIN</span> address <span class="token keyword">AS</span> address_2 <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address_2<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> address_1<span class="token punctuation">.</span>email_address <span class="token operator">=</span> :email_address_1
<span class="token operator">AND</span> address_2<span class="token punctuation">.</span>email_address <span class="token operator">=</span> :email_address_2
</code></pre></div><p>You can use join clause in <code>aliased()</code> object using <code>relationship()</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_1 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account_1<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span> user_account <span class="token keyword">AS</span> user_account_1
<span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h3 id="expanding-on-conditions"><a href="#expanding-on-conditions" class="header-anchor">#</a> Expanding ON Conditions</h3> <p>You can add conditions to the ON clause created by <code>relation()</code>. This feature is useful not only for quickly limiting the scope of a specific join for a related path but also for use cases like loader strategy configuration introduced in the last section.
<a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/internals.html#sqlalchemy.orm.PropComparator.and_)"><code>PropComparator.and_()</code></a> method allows a series of SQL expressions to be positionally combined in the JOIN's <code>ON</code> clause via <code>AND</code>.
For example, to limit the ON criteria to specific email addresses using <code>User</code> and <code>Address</code>, you would do this.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>and_<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> address<span class="token punctuation">.</span>email_address <span class="token operator">=</span> ?
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="exists-has-and"><a href="#exists-has-and" class="header-anchor">#</a> EXISTS <code>has()</code> , <code>and()</code></h3> <p>In the <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#exists-서브쿼리들)">EXISTS Subqueries</a> section, the SQL EXISTS keyword was introduced along with the <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#스칼라-서브-쿼리-상호연관-쿼리)">Scalar Subqueries, Correlated Queries</a> section.
<code>relationship()</code> provides some help in commonly creating subqueries for relationships.</p> <br> <p>For a 1:N (one-to-many) relationship like <code>User.addresses</code>, you can use <code>PropComparator.any()</code> to create a subquery for the address table rejoining the <code>user_account</code> table. This method allows optional WHERE criteria to limit the rows matching the subquery.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> address<span class="token punctuation">.</span>email_address <span class="token operator">=</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>Conversely, to find objects without related data, use <code>~User.addresses.any()</code> to search for <code>User</code> objects.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span><span class="token operator">~</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Patrick McStar'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Squidward Tentacles'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Eugene H. Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> <span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p><code>PropComparator.has()</code> works similarly to <code>PropComparator.any()</code> but is used for N:1 (Many-to-one) relationships.
For instance, to find all <code>Address</code> objects belonging to &quot;pearl&quot;, you would use this method.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>has<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">&quot;pkrabs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="relationship-operators"><a href="#relationship-operators" class="header-anchor">#</a> Relationship Operators</h3> <p>Several types of SQL creation helpers come with <code>relationship()</code>:</p> <ul><li>N : 1 (Many-to-one) comparison
You can select rows where the foreign key of the target entity matches the primary key value of a specified object instance in an N:1 relationship.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user <span class="token operator">==</span> u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> :param_1 <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><ul><li>NOT N : 1 (Many-to-one) comparison
You can use the not equal (!=) operator.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user <span class="token operator">!=</span> u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">!=</span> :user_id_1 <span class="token operator">OR</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IS</span> <span class="token boolean">NULL</span>
</code></pre></div><ul><li>You can check if an object is included in a 1:N (one-to-many) collection.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> :param_1
</code></pre></div><ul><li>You can check if an object in a 1:N relationship is part of a specific parent item. <code>with_parent()</code> creates a comparison that returns rows referencing the given parent item, equivalent to using the <code>==</code> operator.&quot;</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> with_parent
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>with_parent<span class="token punctuation">(</span>u1<span class="token punctuation">,</span> User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> :param_1 <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h2 id="types-of-relationship-loading"><a href="#types-of-relationship-loading" class="header-anchor">#</a> Types of Relationship Loading</h2> <br> <p>In the <a href="#loading-relationships">Loading Relationships</a> section, we introduced the concept that when working with mapped object instances and accessing mapped attributes using <code>relationship()</code>, objects that should be in this collection are loaded, and if the collection is not filled, <em>lazy load</em> occurs.</p> <p>Lazy loading is one of the most famous ORM patterns and also the most controversial. If dozens of ORM objects in memory each refer to a few unloaded properties, the routine manipulation of objects can implicitly release many problems (<a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/glossary.html#term-N-plus-one-problem)"><code>N+1 Problem</code></a>), which can accumulate. Such implicit queries may not work at all when attempting database transformations that are no longer viable or when using alternative concurrency patterns like asynchronous.</p> <blockquote><p>What is a <a href="(https://blog.naver.com/yysdntjq/222405755893)"><code>N + 1 Problem</code></a>?
It's a problem where you fetch N records with one query, but to get the desired data, you end up performing a secondary query for each of these N records.</p></blockquote> <p>Lazy loading is a very popular and useful pattern when it is compatible with the concurrency approach in use and does not cause other problems. For this reason, SQLAlchemy's ORM focuses on features that allow you to permit and optimize these load behaviors.</p> <p>Above all, the first step to effectively using ORM's lazy loading is to <strong>test the Application and check the SQL</strong>.
If inappropriate loads occur for objects detached from the <code>Session</code>, the use of <strong><a href="#types-of-relationship-loading"><code>Types of Relationship Loading</code></a></strong> should be reviewed.</p> <p>You can mark objects to be associated with a SELECT statement using the <code>Select.options()</code> method.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> user_obj <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
    select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_obj<span class="token punctuation">.</span>addresses  <span class="token comment"># access addresses collection already loaded</span>
</code></pre></div><p>You can also configure it as a default for <code>relationship()</code> using <code>relationship.lazy</code>.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
class <span class="token keyword">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span>:
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;selectin&quot;</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>cf. <strong>Two Techniques of Relationship Loading</strong></p> <ul><li><a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/orm/loading_relationships.html#relationship-lazy-option)"><code>Configuring Loader Strategies at Mapping Time</code></a> <ul><li>Details about <code>relationship()</code> configuration</li></ul></li> <li><a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/orm/loading_relationships.html#relationship-loader-options)"><code>Relationship Loading with Loader Options</code></a> <ul><li>Details about the loader</li></ul></li></ul></blockquote> <br> <h3 id="select-in-loading-method"><a href="#select-in-loading-method" class="header-anchor">#</a> Select IN loading Method</h3> <p>The most useful loading option in recent SQLAlchemy versions is <code>selectinload()</code>. This option solves the most common form of the &quot;N+1 Problem&quot; problem, which is an issue with sets of objects referencing related collections. It typically uses a SELECT form that can be sent out for the related table without introducing JOINs or subqueries and only queries for parent objects whose collections are not loaded.</p> <p>The following example shows the Address objects related to a <code>User</code> object being loaded with <code>selectinload()</code>. During the <code>Session.execute()</code> call, two SELECT statements are generated in the database, with the second fetching the related <code>Address</code> objects.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">select</span><span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">session</span><span class="token punctuation">.</span><span class="token keyword">execute</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>:
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">&quot;{row.User.name}  ({', '.join(a.email_address for a in row.User.addresses)})&quot;</span><span class="token punctuation">)</span>
spongebob  <span class="token punctuation">(</span>spongebob<span class="token variable">@sqlalchemy.org</span><span class="token punctuation">)</span>
sandy  <span class="token punctuation">(</span>sandy<span class="token variable">@sqlalchemy.org</span><span class="token punctuation">,</span> sandy<span class="token variable">@squirrelpower.org</span><span class="token punctuation">)</span>
patrick  <span class="token punctuation">(</span><span class="token punctuation">)</span>
squidward  <span class="token punctuation">(</span><span class="token punctuation">)</span>
ehkrabs  <span class="token punctuation">(</span><span class="token punctuation">)</span>
pkrabs  <span class="token punctuation">(</span>pearl<span class="token punctuation">.</span>krabs<span class="token variable">@gmail.com</span><span class="token punctuation">,</span> pearl<span class="token variable">@aol.com</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_account<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="joined-loading-method"><a href="#joined-loading-method" class="header-anchor">#</a> Joined Loading Method</h3> <p><em>Joined Loading</em>, the oldest in SQLAlchemy, is a type of eager loading, also known as <code>joined eager loading</code>. It is best suited for loading objects in &quot;N:1 relationships&quot;, as it performs a SELECT JOIN of the tables specified in <code>relationship()</code>, fetching all table data at once.</p> <p>For example, where an <code>Address</code> object has a connected user, an INNER JOIN can be used rather than an OUTER JOIN.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> joinedload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">,</span> innerjoin<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

spongebob@sqlalchemy<span class="token punctuation">.</span>org spongebob
sandy@sqlalchemy<span class="token punctuation">.</span>org sandy
sandy@squirrelpower<span class="token punctuation">.</span>org sandy
pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com pkrabs
pearl@aol<span class="token punctuation">.</span>com pkrabs
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span>
user_account_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> address
<span class="token keyword">JOIN</span> user_account <span class="token keyword">AS</span> user_account_1 <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><code>joinedload()</code> is also used for 1: N collections but should be evaluated case-by-case compared to other options like <code>selectinload()</code> due to its nested collections and larger collections.</p> <p>It's important to note that the WHERE and ORDER BY criteria of the SELECT query <strong>do not target the table rendered by <code>joinload()</code></strong>. In the SQL query above, you can see an <strong>anonymous alias</strong> applied to the <code>user_account</code> table, which cannot directly address. This concept is further explained in the [Zen of joined Eager Loading] section.</p> <p>The ON clause by <code>joinedload()</code> can be directly influenced using the method described previously in <a href="#expanding-on-conditions"><code>Expanding ON Conditions</code></a>.</p> <blockquote><p>cf.</p> <p>In general cases, &quot;N+1 problem&quot; is much less prevalent, so many-to-one eager loading is often unnecessary.</p> <p>When many objects all reference the same related object (e.g., many <code>Address</code> objects referencing the same <code>User</code>), a single SQL for the <code>User</code> object is emitted using ordinary lazy loading.</p> <p>The lazy loading routine queries the related object by the current primary key without emitting SQL if possible.</p></blockquote> <br> <h3 id="explicit-join-eager-load-method"><a href="#explicit-join-eager-load-method" class="header-anchor">#</a> Explicit Join + Eager Load Method</h3> <p>A common use case uses the <code>contains_eager()</code> option, which is very similar to <code>joinedload()</code> except it assumes you have set up the JOIN directly and instead marks additional columns in the COLUMNS clause that should be loaded into each object's related properties.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> contains_eager

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'pkrabs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>contains_eager<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com pkrabs
pearl@aol<span class="token punctuation">.</span>com pkrabs
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address <span class="token keyword">JOIN</span> user_account <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> ? <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>For instance, we filtered <code>user_account.name</code> and loaded it into the returned <code>Address.user</code> property. A separate application of <code>joinedload()</code> would have unnecessarily created a twice-joined SQL query.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'pkrabs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>  <span class="token comment"># SELECT has a JOIN and LEFT OUTER JOIN unnecessarily</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
user_account_1<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> address <span class="token keyword">JOIN</span> user_account <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> user_account <span class="token keyword">AS</span> user_account_1 <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> :name_1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
</code></pre></div><br> <blockquote><p>cf.</p> <p><strong>Two Techniques of Relationship Loading</strong><br> <a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/orm/loading_relationships.html#zen-of-eager-loading)"><code>Zen of joined Eager Loading</code></a></p> <ul><li>Details about this loading method
<a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/orm/loading_relationships.html#contains-eager)"><code>Routing Explicit Joins/Statements into Eagerly Loaded Collections</code></a></li> <li>using <code>contains_eager()</code></li></ul></blockquote> <br> <h3 id="setting-loader-paths"><a href="#setting-loader-paths" class="header-anchor">#</a> Setting Loader Paths</h3> <p>The <code>PropComparator.and_()</code> method is actually generally usable for most loader options.</p> <p>For example, if you want to reload usernames and email addresses from the <code>sqlalchemy.org</code> domain, you can limit the conditions with <code>PropComparator.and_()</code> applied to the arguments passed to <code>selectinload()</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       selectinload<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>           User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>and_<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token operator">~</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;sqlalchemy.org&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>           <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   execution_options<span class="token punctuation">(</span>populate_existing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>User<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">  (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a<span class="token punctuation">.</span>email_address <span class="token keyword">for</span> a <span class="token keyword">in</span> row<span class="token punctuation">.</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span><span class="token punctuation">)</span>

spongebob  <span class="token punctuation">(</span><span class="token punctuation">)</span>
sandy  <span class="token punctuation">(</span>sandy@squirrelpower<span class="token punctuation">.</span>org<span class="token punctuation">)</span>
patrick  <span class="token punctuation">(</span><span class="token punctuation">)</span>
squidward  <span class="token punctuation">(</span><span class="token punctuation">)</span>
ehkrabs  <span class="token punctuation">(</span><span class="token punctuation">)</span>
pkrabs  <span class="token punctuation">(</span>pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com<span class="token punctuation">,</span> pearl@aol<span class="token punctuation">.</span>com<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>The above code is equivalent to executing the following query.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_account<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token operator">AND</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span>email_address <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%'</span> <span class="token operator">||</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'sqlalchemy.org'</span><span class="token punctuation">)</span>
</code></pre></div><p>It's crucial to note the addition of the <code>.execution_options(populate_existing=True)</code> <strong>option</strong> above. When fetching rows, this option indicates that loader options must replace the existing collections' contents in already loaded objects.</p> <p>Since we are iterating with a <code>Session</code> object, the objects being loaded here are the same Python instances as those initially maintained at the start of this tutorial's ORM section.</p> <br> <h3 id="raise-loading-method"><a href="#raise-loading-method" class="header-anchor">#</a> Raise Loading Method</h3> <p>The <code>raiseload()</code> option is commonly used to completely block the occurrence of the &quot;N+1 problem&quot; by instead causing errors rather than slow loading.</p> <p>There are two variants: blocking all &quot;load&quot; operations that include works that need SQL (<em>lazy load</em>) and those that only reference the current <code>Session</code> (<code>raiseload.sql_only</code> <strong>option</strong>).</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    <span class="token comment"># ... Column mappings</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;raise_on_sql&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>

    <span class="token comment"># ... Column mappings</span>

    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;addresses&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;raise_on_sql&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Using such mappings blocks the application from 'lazy loading', requiring you to specify loader strategies for specific queries.</p> <div class="language-python extra-class"><pre class="language-python"><code>u1 <span class="token operator">=</span> s<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
u1<span class="token punctuation">.</span>addresses
sqlalchemy<span class="token punctuation">.</span>exc<span class="token punctuation">.</span>InvalidRequestError<span class="token punctuation">:</span> <span class="token string">'User.addresses'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> available due to lazy<span class="token operator">=</span><span class="token string">'raise_on_sql'</span>
</code></pre></div><p>The exception indicates that the collection must be loaded first.</p> <div class="language-python extra-class"><pre class="language-python"><code>u1 <span class="token operator">=</span> s<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>The <code>lazy=&quot;raise_on_sql&quot;</code> option is also wisely attempted for N:1 relationships.</p> <p>Above, although the <code>Address.user</code> property was not loaded into <code>Address</code>, &quot;raiseload&quot; does not cause an error because the corresponding <code>User</code> object is in the same <code>Session</code>.</p> <blockquote><p>cf.</p> <p><a href="/sqlalchemy-for-pythonist/en/tutorial/(https:/docs.sqlalchemy.org/en/20/orm/loading_relationships.html#prevent-lazy-with-raiseload)">Preventing unwanted lazy loading with <code>raiseload</code></a><br> <a href="(https://docs.sqlalchemy.org/en/20/orm/loading_relationships.html)">Preventing lazy loading in <code>relationship</code></a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqlalchemy-for-pythonist/en/tutorial/6. Manipulating Data Using ORM.html" class="prev">
        Manipulating Data Using ORM
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/19.7b4a8a4e.js" defer></script>
  </body>
</html>
