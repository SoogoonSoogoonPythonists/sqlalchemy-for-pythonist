<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Core와 ORM 방식으로 행 조회하기 | 파이썬 개발자를 위한 SQLAlchemy</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-SNPCYHY4R2"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SNPCYHY4R2');</script>
    <meta name="description" content="SQLAlchemy를 쉽게 정리해놓은 문서입니다.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="google-site-verification" content="wjX_mSoZBgO9SZMvjr96yOjo6n3_7pS8xNdmzDl1ESw">
    
    <link rel="preload" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css" as="style"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/26.a287ef6a.js" as="script"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/10.e7fb4c80.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/11.051ae6e1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/12.7b93e986.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/13.8d014a70.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/14.138cd924.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/15.dca0d300.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/16.69771a0f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/17.66ba2d35.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/18.760e3a59.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/19.7b4a8a4e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/20.adec2767.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/21.c59b443d.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/22.f84628fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/23.2c4a7cf3.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/24.7785bb30.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/25.dc95a31e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/27.a111ddcb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/28.b809fce0.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/29.7029d8fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/3.2e213720.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/30.b93101cb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/31.363734c1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/4.51c0545f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/5.220df36c.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/6.345e52dd.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/7.a15a95f4.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/8.006f2d84.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/9.7948c093.js">
    <link rel="stylesheet" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqlalchemy-for-pythonist/" class="home-link router-link-active"><!----> <span class="site-name">파이썬 개발자를 위한 SQLAlchemy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/sqlalchemy-for-pythonist/tutorial/" class="sidebar-heading clickable router-link-active open"><span>Tutorial</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/sqlalchemy-for-pythonist/tutorial/1. 튜토리얼 개요.html" class="sidebar-link">튜토리얼 개요</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/2. 연결 설정하기.html" class="sidebar-link">연결 설정하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/3. 트랜잭션과 쿼리 실행하기.html" class="sidebar-link">트랜잭션과 쿼리 실행하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/4. 데이터베이스 메타데이터로 작업하기.html" class="sidebar-link">데이터베이스 메타데이터로 작업하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html" class="active sidebar-link">Core와 ORM 방식으로 행 조회하기</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#select-를-통한-sql-표현식-구성" class="sidebar-link">select() 를 통한 SQL 표현식 구성</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#from절과-컬럼-세팅하기" class="sidebar-link">FROM절과 컬럼 세팅하기</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#where절" class="sidebar-link">WHERE절</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#from절과-join-명시하기" class="sidebar-link">FROM절과 JOIN 명시하기</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#order-by-group-by-having" class="sidebar-link">ORDER BY, GROUP BY, HAVING</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#별칭-사용하기" class="sidebar-link">별칭 사용하기</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#서브쿼리와-cte" class="sidebar-link">서브쿼리와 CTE</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#스칼라-서브-쿼리-상호연관-쿼리" class="sidebar-link">스칼라 서브 쿼리, 상호연관 쿼리</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#union-union-all-연산자들" class="sidebar-link">UNION, UNION ALL 연산자들</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#exists-서브쿼리들" class="sidebar-link">EXISTS 서브쿼리들</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html#sql-함수-다뤄보기" class="sidebar-link">SQL 함수 다뤄보기</a></li></ul></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.2. Core 방식으로 행 삽입하기.html" class="sidebar-link">Core 방식으로 행 삽입하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.3. Core 방식으로 행 수정 및 삭제하기.html" class="sidebar-link">Core 방식으로 행 수정 및 삭제하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/6. ORM 방식으로 데이터 조작하기.html" class="sidebar-link">ORM 방식으로 데이터 조작하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html" class="sidebar-link">ORM으로 관련 개체 작업하기</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="core와-orm-방식으로-행-조회하기"><a href="#core와-orm-방식으로-행-조회하기" class="header-anchor">#</a> Core와 ORM 방식으로 행 조회하기</h1> <br> <p>이번 챕터에서는 SQLAlchemy에서 가장 자주 쓰이는 Select에 대해서 다룹니다.</p> <br> <h2 id="select-를-통한-sql-표현식-구성"><a href="#select-를-통한-sql-표현식-구성" class="header-anchor">#</a> <code>select()</code> 를 통한 SQL 표현식 구성</h2> <p><code>select()</code> 생성자는 <code>insert()</code> 생성자와 같은 방식으로 쿼리문을 만들 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = :name_1
&quot;&quot;&quot;</span>
</code></pre></div><p>마찬가지로 쿼리문을 실행시키 위해 같은 레벨의 SQL 생성자들(select, insert, update, create등)처럼 <code>Connection.execute()</code> 메서드에 쿼리를 넣어 실행시킬 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> row <span class="token keyword">in</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span>
</code></pre></div><p>한편 ORM을 사용해 <code>select</code> 쿼리문을 실행시키고 싶을 때는 <code>Session.exeucte()</code>를 사용해야합니다.
결과는 방금 전의 예제와 마찬가지로 <code>Row</code>객체를 반환하지만 이 객체는 이전의 튜토리얼, <a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist/blob/main/tutorial/4.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4%20%EB%A9%94%ED%83%80%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A1%9C%20%EC%9E%91%EC%97%85%ED%95%98%EA%B8%B0.md#%ED%85%8C%EC%9D%B4%EB%B8%94%EC%97%90-%EB%A7%A4%ED%95%91%ED%95%A0-%ED%81%B4%EB%9E%98%EC%8A%A4-%EC%84%A0%EC%96%B8" target="_blank" rel="noopener noreferrer">4. 데이터베이스 메타데이터로 작업하기<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에서
정의했던 <code>User</code>객체를 포함하고 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span>
<span class="token comment"># User 객체의 인스턴스 안에 있는 각 row 들을 출력</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
<span class="token punctuation">(</span>User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><br> <h2 id="from절과-컬럼-세팅하기"><a href="#from절과-컬럼-세팅하기" class="header-anchor">#</a> FROM절과 컬럼 세팅하기</h2> <p><code>select()</code>함수는 위치인자로 <code>Column</code>이나 <code>Table</code>등을 포함한 다양한 객체들을 받을 수 있습니다.
이러한 인자 값들은 <code>select()</code>함수의 반환 값, 즉 SQL쿼리문으로 표현 될 수있고 <code>FROM</code>절을 세팅해주기도 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>각각의 컬럼들을 <code>Core</code>를 이용해 조회하려면 <code>Table.c</code>접근자를 통해 <code>Column</code>객체에 접근하면 됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, user_account.fullname
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="orm-엔터티-및-열-조회"><a href="#orm-엔터티-및-열-조회" class="header-anchor">#</a> ORM 엔터티 및 열 조회</h3> <p>SQL 쿼리를  SqlAlchemy에서 구현할 때 테이블이나 컬럼을 표현하기 위해 <code>User</code>객체같은 ORM 엔터티나, <code>User.name</code>과 같이  컬럼이 매핑된 속성(어트리뷰트)을 사용할 수 있습니다.
아래의 예제는  <code>User</code>엔터티를 조회하는 예제이지만 사실은
<code>user_table</code> 를 사용했을 때와 결과가 동일합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>위의 예제의 쿼리를 ORM <code>Session.exeucte()</code>를 통해 똑같이 실행 할 수 있는데, 이때는  <code>User</code>엔터티를 조회하는 것과 <code>user_info</code>를 조회하는 것에 차이가 있습니다.
<code>user_info</code>를 조회하든 <code>User</code>엔티티를  조회 하든 둘 다<code>Row</code>객체가 반환되지만 <code>User</code>엔터티를 조회 할 경우에는
<code>User</code>인스턴스를 포함한 <code>Row</code> 객체가 반환됩니다.</p> <blockquote><p>여기서 <code>user_table</code>과 <code>User</code>는 <a href="">이전 챕터</a>에서 만들어졌는데,
<code>user_table</code>은 <code>Table</code> 객체이고
<code>User</code>는  <code>Base</code> 객체를  상속받아<code>Table</code>객체를 포함하고 있는 엔터티입니다.</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     row <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
<span class="token punctuation">(</span>User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span>fullname<span class="token operator">=</span><span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>한편 객체 속성(class-bound attributes)을 사용해 원하는 컬럼들을 조회할 수도 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, user_account.fullname
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>객체 속성을 <code>Session.execute()</code>을 이용해 조회 할 경우에는
인자로 보내진 객체 속성의 값(컬럼 값)이 아래와 같이 반환됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	row <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	<span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span>
</code></pre></div><p>이러한 방법들은 믹스인 방법으로 섞어서 사용할 수도 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">,</span> Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token operator">==</span>Address<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h3 id="라벨링된-sql-표현식-조회하기"><a href="#라벨링된-sql-표현식-조회하기" class="header-anchor">#</a> 라벨링된 SQL 표현식 조회하기</h3> <p><code>SELECT name AS username FROM user_account</code> 쿼리를 실행 할 경우 아래와 같은 결과가 나옵니다.</p> <table><thead><tr><th>username</th></tr></thead> <tbody><tr><td>patrick</td></tr> <tr><td>sandy</td></tr> <tr><td>spongebob</td></tr></tbody></table> <p>여기서 우리는 <code>name</code>컬럼의 이름을 <code>username</code>으로 라벨링 해줬기 때문에 상단 컬럼에 <code>username</code> 이 뜨는 건데요.
이러한 기능을 SQLAlchemy의 <code>ColumnElement.label()</code>함수를 이용해 동일하게 구현할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func<span class="token punctuation">,</span> cast
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token punctuation">(</span><span class="token string">&quot;Username: &quot;</span> <span class="token operator">+</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 이렇게 라벨링 합니다.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> row <span class="token keyword">in</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>username<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>  <span class="token comment"># 라벨링한 부분은 이렇게 접근할 수 있습니다.</span>
Username<span class="token punctuation">:</span> patrick
Username<span class="token punctuation">:</span> sandy
Username<span class="token punctuation">:</span> spongebob
</code></pre></div><br> <h3 id="문자열-컬럼-조회하기"><a href="#문자열-컬럼-조회하기" class="header-anchor">#</a> 문자열 컬럼 조회하기</h3> <p>보통 <code>Select</code>객체나 <code>select()</code> 생성자를 이용 해 컬럼을 조회하는 경우가 많지만 가끔은 임의로 문자열과 함께 컬럼을 조회 해야하는 경우가 있습니다. 이번 섹션에서는 이러한 스트링 데이터를 조회 하는 방법에 다룹니다.</p> <p><code>text()</code> 생성자는 이전 챕터 <a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist/blob/main/tutorial/3.%20%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%20%EB%B0%8F%20DBAPI%20%EC%9E%91%EC%97%85.md" target="_blank" rel="noopener noreferrer">3. 트랜잭션 및 데이터베이스API 작업<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에서 한 번 소개가 되었는데요, 이 <code>text()</code>생성자안에  <code>SELECT</code>구문을 곧바로 넣어 사용할 수도 있었습니다.</p> <p>한편 우리는  <code>SELECT 'some_phrase', name FROM user_account</code> 와 같은 쿼리를 실행시키고 싶다고 생각해봅시다.
이 때, <code>some_phrase</code>은 문자열이기 때문에 꼭 큰 따옴표나 작은 따옴표로 감싸줘야합니다. 그리고 그 결과, 출력물에도 어쩔 수 없이 작은 따옴표가 전부 붙어서 나옵니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> text
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         text<span class="token punctuation">(</span><span class="token string">&quot;'some phrase'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'some phrase'</span><span class="token punctuation">,</span> <span class="token string">'patrick'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'some phrase'</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'some phrase'</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>그래서 보통은 <code>text()</code>보다 <code>literal_column()</code>을 사용해 작은 따옴표가 결과물에 붙어져서 나오는 문제를 해결할 수 있습니다.<br>
여기에서  <code>text</code>와 <code>literal_column()</code>은 거의 비슷하지만  <code>literal_column()</code>은 명시적으로 컬럼을 의미하고, 서브쿼리나 다른 SQL 표현식에서 쓰일 수 있게 라벨링도 할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> literal_column
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         literal_column<span class="token punctuation">(</span><span class="token string">&quot;'some phrase'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> row <span class="token keyword">in</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>p<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
some phrase<span class="token punctuation">,</span> patrick
some phrase<span class="token punctuation">,</span> sandy
some phrase<span class="token punctuation">,</span> spongebob

</code></pre></div><br> <h2 id="where절"><a href="#where절" class="header-anchor">#</a> WHERE절</h2> <p>SQLAlchemy를 사용하면 Python 연산자를 사용하여 <code>name</code> = 'thead'<code>또는</code>user_id &gt; 10` 인 데이터만 출력하는 쿼리를 쉽게 작성할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'squidward'</span><span class="token punctuation">)</span>
user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">:</span>name_1

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
address<span class="token punctuation">.</span>user_id <span class="token operator">&gt;</span> <span class="token punctuation">:</span>user_id_1
</code></pre></div><p><code>WHERE</code>절을 만들기 위해 <code>Select.where()</code>메서드안에 인자값을 넣어 사용할 수도 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'squidward'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = :name_1
&quot;&quot;&quot;</span>
</code></pre></div><p>WHERE 절을 통한 JOIN을 구현해야 할 때, 아래와 같이 작성 가능합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         select<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'squidward'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         where<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id <span class="token operator">==</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.email_address
FROM address, user_account
WHERE user_account.name = :name_1 AND address.user_id = user_account.id
&quot;&quot;&quot;</span>

<span class="token comment"># 위와 같은 표현이지만, 아래처럼 where()메서드의 파라미터로 넘기는 방식도 가능합니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         where<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'squidward'</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id <span class="token operator">==</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.email_address
FROM address, user_account
WHERE user_account.name = :name_1 AND address.user_id = user_account.id
&quot;&quot;&quot;</span>
</code></pre></div><p><code>and_()</code>, <code>or_()</code>등의 연결 구문도 구현가능합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_<span class="token punctuation">,</span> or_
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         where<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             and_<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 or_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'squidward'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'sandy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 Address<span class="token punctuation">.</span>user_id <span class="token operator">==</span> User<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.email_address
FROM address, user_account
WHERE (user_account.name = :name_1 OR user_account.name = :name_2)
AND address.user_id = user_account.id
&quot;&quot;&quot;</span>
</code></pre></div><p>단순히 같은지, 아닌지 비교하는 경우(equality) <code>Select.filter_by()</code>도 자주 사용됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = :name_1 AND user_account.fullname = :fullname_1
&quot;&quot;&quot;</span>
</code></pre></div><br> <h2 id="from절과-join-명시하기"><a href="#from절과-join-명시하기" class="header-anchor">#</a> FROM절과 JOIN 명시하기</h2> <p>앞에서 언급했지만 <code>FROM</code>절은 따로 명시하지 않아도 <code>select()</code>메서드의 인자에 넣은 컬럼들로 자동 세팅이 됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 따로 FROM 절을 명시하지 않았지만 FROM 절이 세팅되어 출력됩니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>만약 <code>select()</code>의 위치 인자로  서로 다른 두 개의 테이블을  참조하는 컬럼을<code>,</code>(컴마)로 구분지어 넣을 수도 있습니다</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, address.email_address
FROM user_account, address
&quot;&quot;&quot;</span>
</code></pre></div><p>서로 다른 두 개의 테이블을 <code>JOIN</code>조인하고 싶다면, 이용할 수 있는 메서드가 두 가지가 있는데요,
하나는 <code>Select.join()</code>메서드로 명시적으로 <code>JOIN</code> 할 왼쪽에 들어갈 테이블, 오른쪽에 들어 갈 테이블을 직접 지정할 수 있습니다</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>user_table<span class="token punctuation">,</span> address_table<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, address.email_address
FROM user_account JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><p>다른 하나는 <code>Select.join()</code>메서드로 오른쪽에 들어갈 테이블만 명시적으로 적어주고
나머지 테이블은 암시적으로 컬럼을 선택할 때 참조하게 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 위와 동일한 표현이지만, 조인할 왼쪽 테이블(user_table)은 암시적으로 표현됩니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>address_table<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, address.email_address
FROM user_account JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><p>또는 <code>JOIN</code> 하는 두 개의 테이블을 조금 더 명시적으로 작성하고 싶거나 <code>FROM</code>절에 명시적인 추가 옵션을 주고 싶다면
아래와 같이 작성 할 수도 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.email_address
FROM user_account JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><p><code>Select.select_from()</code>을 사용하는 또 다른 경우는 우리가 조회하고 싶은 컬럼들을 통해 암시적으로 <code>FROM</code> 절을 세팅할 수 없는 경우입니다.   예를 들면 일반적인 SQL 쿼리문에서 <code>count(*)</code>를 조회하기 위해선  SQLAlchemy의 <code>sqlalchemy.sql.expression.func</code>를 사용해야합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT count(:count_2) AS count_1
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="on절-세팅하기"><a href="#on절-세팅하기" class="header-anchor">#</a> On절 세팅하기</h3> <p>그런데 뭔가 이상한게 있었죠?
사실 이 전의 예제에서 <code>Select.select_from()</code>이나 <code>select.join()</code>을 이용해 두 테이블을 <code>JOIN</code>할 때 암시적으로 <code>ON</code>절이 세팅되었답니다.<br>
왜 자동으로  <code>ON</code> 절이 세팅 됐냐면, <code>user_table</code>객체와, <code>address_table</code> 객체가 <code>ForeignKeyConstraint</code>, 즉 외부키 제약을 갖고 있어서 자동으로 세팅이 된 것입니다.</p> <p>만약에 <code>Join</code>의 대상인 두 개의 테이블에서 이러한 제약 key가 없을 경우 <code>ON</code>절을 직접 지정해야 합니다. 이러한 기능은 <code>Select.join()</code>나 <code>Select.join_from()</code>메서드에 파라미터 전달을 통해 명시적으로 <code>ON</code>절을 세팅할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>address_table<span class="token punctuation">,</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.email_address
FROM user_account JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="outer-full-join"><a href="#outer-full-join" class="header-anchor">#</a> OUTER, FULL Join</h3> <p>SQLAlchemy에서 <code>LEFT OUTER JOIN</code>, <code>FULL OUTER JOIN</code>를 구현하려면
<code>Select.join()</code>과 <code>Select.join_from()</code>메서드의 키워드 인자로 <code>Select.join.isouter</code>,
<code>Select.join.full</code>를 사용할 수 있습니다.</p> <p><code>LEFT OUTER JOIN</code>을 구현 한 경우,</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">,</span> isouter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account LEFT OUTER JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><p><code>FULL OUTER JOIN</code>을 구현 한 경우,</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">,</span> full<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account FULL OUTER JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>
</code></pre></div><br> <h2 id="order-by-group-by-having"><a href="#order-by-group-by-having" class="header-anchor">#</a> ORDER BY, GROUP BY, HAVING</h2> <ul><li><code>ORDER BY</code>절은 <code>SELECT</code>절에서 조회한 행들의 순서를 설정할 수 있습니다.</li> <li><code>GROUP BY</code>절은 그룹 함수로 조회된 행들을 특정한 컬럼을 기준으로 그룹을 만듭니다.</li> <li><code>HAVING</code>은 <code>GROUP BY</code>절을 통해 생성된 그룹에 대해 조건을 겁니다.</li></ul> <br> <h3 id="order-by"><a href="#order-by" class="header-anchor">#</a> ORDER BY</h3> <p><code>Select.order_by()</code>를 이용해 <code>ORDER BY</code>기능을 구현할 수 있습니다. 이때 위치 인자 값으로 <code>Column</code>객체나 이와 비슷한 객체들을 받을 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account ORDER BY user_account.name
&quot;&quot;&quot;</span>
</code></pre></div><p>오름차순, 내림차순은
<code>ColumnElement.asc()</code>, <code>ColumnElement.desc()</code> 제한자를 통해  구현 할 수 있습니다.
아래 예제는 <code>user_account.fullname</code>컬럼 기준으로 내림 차순으로 정렬합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account ORDER BY user_account.fullname DESC
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="그룹함수-group-by-having"><a href="#그룹함수-group-by-having" class="header-anchor">#</a> 그룹함수 : GROUP BY, Having</h3> <p>SQL에서는 집계함수를 이용해 조회 된 여러개의 행들을 하나의 행으로 합칠 수도 있습니다.
집계함수의 예로 <code>COUNT()</code>, <code>SUM()</code>, <code>AVG()</code>등이 있습니다.</p> <p>SQLAlchemy에서는  <code>func</code>라는 네임스페이스를 이용해 SQL함수를 제공하는데, 이 <code>func</code>는
SQL함수의 이름이 주어지면  <code>Function</code>인스턴스를 생성합니다.</p> <p>아래의 예제에서는 <code>user_account.id</code>컬럼을 SQL <code>COUNT()</code>함수에 렌더링 하기 위해 <code>count()</code>함수를 호출합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> count_fn <span class="token operator">=</span> func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>count_fn<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
count(user_account.id)
&quot;&quot;&quot;</span>
</code></pre></div><p>SQL 함수에 관해서는 <a href="">SQL 함수 다루기</a>에서 더 자세히 설명되어 있습니다.</p> <p>다시 설명하자면</p> <ul><li><code>GROUP BY</code>는 조회된 행들을 특정 그룹으로 나눌 때 필요한 함수입니다.
만약에 <code>SELECT</code> 절에서 몇 개의 컬럼을 조회 할 경우  SQL에서는 직,간접적으로 이 컬럼들이  기본키(primary key)를 기준으로
<code>GROUP BY</code>에 종속되도록 합니다.</li> <li><code>HAVING</code> 는 <code>GROUP BY</code>로 만들어진 그룹들에 대해 조건을 적용 할 경우 필요합니다.(그룹에 대해 조건을 걸기 때문에 <code>WHERE</code>절과 비슷합니다)</li></ul> <p>SQLAlchemy에서는 <code>Select.group_by()</code>와 <code>Select.having()</code>를 이용해 <code>GROUP BY</code>와 <code>HAVING</code>을 구현 할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">,</span> func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         join<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         group_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         having<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot; 위 구문은 아래 SQL을 표현합니다.
SELECT user_account.name, count(address.id) AS count
FROM user_account JOIN address ON user_account.id = address.user_id GROUP BY user_account.name
HAVING count(address.id) &gt; ?
[...] (1,)
&quot;&quot;&quot;</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h3 id="별칭을-통해-그룹화-또는-순서-정렬하기"><a href="#별칭을-통해-그룹화-또는-순서-정렬하기" class="header-anchor">#</a> 별칭을 통해 그룹화 또는 순서 정렬하기</h3> <p>어떤 데이터 베이스 백엔드에서는 집계함수를 사용해 테이블을 조회 할 때 <code>ORDER BY</code> 절이나 <code>GROUP BY</code>절에 이미 명시된  집계함수를 <strong>다시</strong> 명시적으로 사용하지 않는 것이 중요합니다.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># NOT GOOD</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> user_account <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

<span class="token comment"># CORRECT</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt_id <span class="token keyword">FROM</span> user_account <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> cnt_id
</code></pre></div><p>따라서  별칭을 통해 <code>ORDER BY</code> 나 <code>GROUP BY</code>를 구현하려면
<code>Select.order_by()</code> 또는 <code>Select.group_by()</code>메서드에 인자로 사용 할 별칭을 넣어주면 됩니다.<br>
여기에 사용된 별칭이 먼저 렌더링 되는건 아니고  컬럼절에 사용된 별칭이 먼저 렌더링 됩니다. 그리고 렌더링된 별칭이 나머지 쿼리문에서 매칭되는게 없다면 에러가 발생합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func<span class="token punctuation">,</span> desc
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 컬럼에도 num_addresses 별칭이 들어가고 order_by에도 같은 별칭이 들어갑니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         Address<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">'num_addresses'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         group_by<span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> desc<span class="token punctuation">(</span><span class="token string">&quot;num_addresses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT address.user_id, count(address.id) AS num_addresses
FROM address GROUP BY address.user_id ORDER BY address.user_id, num_addresses DESC
&quot;&quot;&quot;</span>
</code></pre></div><br> <h2 id="별칭-사용하기"><a href="#별칭-사용하기" class="header-anchor">#</a> 별칭 사용하기</h2> <p>여러개의 테이블을 <code>JOIN</code>을 이용해 조회 할 경우 쿼리문에서 테이블 이름을 여러번 적어줘야 하는 경우가 많습니다.
SQL에서는 이러한 문제를 테이블 명이나 서브 쿼리에 별칭(aliases)를 지어 반복되는 부분을 줄일 수 있습니다.</p> <p>한편 SQLAlchemy에서는 이러한 별칭들은 Core의 <code>FromCaluse.alias()</code>함수를 이용해 구현 할 수 있습니다.
<code>Table</code>객체 네임스페이스 안에 <code>Column</code>객체가 있어 <code>Table.c</code>로 컬럼명에 접근할 수 있었는데요.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, user_account.fullname
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p><code>Alias</code>객체 네임스페이스 안에도 <code>Column</code>객체가 있어 <code>Alias.c</code>로 컬럼에 접근 가능합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># user_alias_1과 user_alias_2 모두 Alias객체입니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_1 <span class="token operator">=</span> user_table<span class="token punctuation">.</span>alias<span class="token punctuation">(</span>‘table1’<span class="token punctuation">)</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_2 <span class="token operator">=</span> user_table<span class="token punctuation">.</span>alias<span class="token punctuation">(</span>‘table2’<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 방금 만든 테이블 별명으로 컬럼에 접근하려면 Alias.c.컬럼명으로 접근해야합니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_alias_2<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">,</span> user_alias_2<span class="token punctuation">,</span> user_alias_1<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">&gt;</span> user_alias_2<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT table1.name, table2.name AS name_1 
FROM user_account AS table1 JOIN user_account AS table2 ON table1.id &gt; table2.id
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="orm-엔티티-별칭"><a href="#orm-엔티티-별칭" class="header-anchor">#</a> ORM 엔티티 별칭</h3> <p>ORM도  <code>FromClause.alias()</code>메서드와 비슷한 <code>aliased()</code>함수가 존재합니다.</p> <p>이 ORM <code>aliased()</code>는 ORM의 기능을 유지하면서 원래 매핑된 <code>Table</code>객체에 내부적으로 <code>Alias</code>객체를 생성합니다.</p> <blockquote><p>여기서 <code>Address</code>와 <code>User</code>객체는 <a href="">이전 챕터</a>에서 만들어졌는데,
두 객체 모두  <code>Base</code> 객체를  상속받아<code>Table</code>객체를 포함하고 있는 엔터티입니다.</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_1 <span class="token operator">=</span> user_table<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_2 <span class="token operator">=</span> user_table<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 예제에서는 User나 Address엔터티에 적용됩니다.  </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_1<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_1<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_2<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_2<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@gmail.com'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id, user_account.name, user_account.fullname 
FROM user_account JOIN address AS address_1 ON user_account.id = address_1.user_id JOIN address AS address_2 ON user
&quot;&quot;&quot;</span>
</code></pre></div><br> <h2 id="서브쿼리와-cte"><a href="#서브쿼리와-cte" class="header-anchor">#</a> 서브쿼리와 CTE</h2> <p>이 섹션에서는 일반적으로 SELECT의 FROM 절에 있는 서브 쿼리에 대해 설명합니다. 서브쿼리와 유사한 방식으로 사용되지만 추가 기능이 포함된 CTE도 다룹니다.</p> <blockquote><p>CTE(Common Table Expression)는 동일 쿼리 내에서 여러번 참조할 수 있게 하는 쿼리 내 임시 결과 집합입니다. <a href="https://blog.sengwoolee.dev/84" target="_blank" rel="noopener noreferrer">이 글<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에 CTE에 대해 잘 설명되어 있으니, 잘 모르시겠는 분들은 참고하시면 좋습니다.</p></blockquote> <p>SQLAlchemy는 <code>Subquery</code> 개체를
<code>Select.subquery()</code>사용하여 서브 쿼리를 나타내고 <code>Select.cte()</code> 를 사용하여 CTE를 나타냅니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>group_by<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>subq<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT count(address.id) AS count, address.user_id
FROM address GROUP BY address.user_id
&quot;&quot;&quot;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    subq<span class="token punctuation">.</span>c<span class="token punctuation">.</span>count
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>join_from<span class="token punctuation">(</span>user_table<span class="token punctuation">,</span> subq<span class="token punctuation">)</span> <span class="token comment"># ON절은 두 개의 테이블이 이미 foreigh key로 제약이 걸려있어 자동 바인딩된다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, user_account.fullname, anon_1.count
FROM user_account JOIN (SELECT count(address.id) AS count, address.user_id AS user_id
FROM address GROUP BY address.user_id) AS anon_1 ON user_account.id = anon_1.user_id
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="계층-쿼리"><a href="#계층-쿼리" class="header-anchor">#</a> 계층 쿼리</h3> <p>SQLAlchemy에서 CTE 구문을 사용하는 방법은 서브 쿼리 구문이 사용되는 방식과 거의 동일합니다. 대신 <code>Select.subquery()</code> 메서드의 호출을 <code>Select.cte()</code>를 사용하도록 변경하여 결과 객체를 FROM 요소로 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>group_by<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>cte<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    subq<span class="token punctuation">.</span>c<span class="token punctuation">.</span>count
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>join_from<span class="token punctuation">(</span>user_table<span class="token punctuation">,</span> subq<span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
WITH anon_1 AS
(SELECT count(address.id) AS count, address.user_id AS user_id
FROM address GROUP BY address.user_id)
 SELECT user_account.name, user_account.fullname, anon_1.count
FROM user_account JOIN anon_1 ON user_account.id = anon_1.user_id
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="orm-엔티티-서브쿼리-cte"><a href="#orm-엔티티-서브쿼리-cte" class="header-anchor">#</a> ORM 엔티티 서브쿼리, CTE</h3> <p>여기서는 <code>aliased()</code>가 <code>Subquery</code>, <code>CTE</code>서브 쿼리에 대해 동일한 작업을 수행하는 과정을 확인할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token operator">~</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">'%@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_subq <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">,</span> subq<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_subq<span class="token punctuation">)</span><span class="token punctuation">.</span>join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_subq<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> address_subq<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> user<span class="token punctuation">,</span> address <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>address<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot; 위 구문은 아래 쿼리를 표현합니다.
SELECT user_account.id, user_account.name, user_account.fullname,
anon_1.id AS id_1, anon_1.email_address, anon_1.user_id
FROM user_account JOIN
(SELECT address.id AS id, address.email_address AS email_address, address.user_id AS user_id
FROM address
WHERE address.email_address NOT LIKE ?) AS anon_1 ON user_account.id = anon_1.user_id
ORDER BY user_account.id, anon_1.id
[...] ('%@aol.com',)
&quot;&quot;&quot;</span>

User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span>
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span>
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span>
</code></pre></div><p>아래는 CTE생성자를 이용해 위와 같은  사용하는 예제입니다</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> cte <span class="token operator">=</span> select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token operator">~</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">'%@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cte<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_cte <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">,</span> cte<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_cte<span class="token punctuation">)</span><span class="token punctuation">.</span>join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_cte<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> address_cte<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> user<span class="token punctuation">,</span> address <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>address<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span>
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span>
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span>
</code></pre></div><br> <h2 id="스칼라-서브-쿼리-상호연관-쿼리"><a href="#스칼라-서브-쿼리-상호연관-쿼리" class="header-anchor">#</a> 스칼라 서브 쿼리, 상호연관 쿼리</h2> <p>스칼라 서브 쿼리에 대해 설명하기전 잠시 SQL에서 서브 쿼리에 대해 이야기 하겠습니다. <a href="https://rinuas.tistory.com/entry/%EC%84%9C%EB%B8%8C%EC%BF%BC%EB%A6%ACSub-Query" target="_blank" rel="noopener noreferrer">출처:바이헨 블로그<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>&quot;서브쿼리&quot;란 하나의 SQL문에 속한 <code>SELECT</code>문을 말하고 서브 쿼리의 바깥 쪽에 있는 SQL문을 &quot;메인 쿼리&quot;라고 합니다.</li></ul> <p>이때 서브쿼리의 종류는 메인 쿼리 컬럼을 참조 여부, 서브쿼리의 선언 위치, 서브 쿼리 실행 결과 ROW수에 따라 종류가 나눠집니다</p> <ul><li>메인 쿼리 컬럼 참조 여부에 따른 구분
<ul><li><strong>상호 연관 서브쿼리</strong> : 서브쿼리가 메인 쿼리 컬럼을 참조</li> <li>비상호 연관 서브 쿼리: 서브쿼리가 메인 쿼리의 컬럼을 참조하지 않고 독립적으로 수행하고 메인쿼리에 정보를 전달할 목적으로 사용됩니다.</li></ul></li> <li>서브쿼리 선언 위치에 따른 구분
<ul><li><strong>스칼라 서브 쿼리</strong> : SELECT 문의 컬럼자리에 오는 서브 쿼리(상호 연관 서브쿼리)</li> <li>인라인 뷰 : FROM절 자리에 오는 서브 쿼리 (상호 연관 서브 쿼리)</li> <li>중첩 서브 쿼리 : Where절 자리에 오는 서브 쿼리 (비상호 연관 서브 쿼리)</li></ul></li> <li>서브 쿼리 실행 결과 ROW수에 따른 구분
<ul><li>단일행 서브쿼리(서브 쿼리 연산결과 ROW1개)</li> <li>단중행 서브쿼리(서브 쿼리 연산결과 ROW2개이상):IN, ANY, ALL, EXSITS</li></ul></li></ul> <br> <p>SQLAlchemy에서 스칼라 서브 쿼리는 <code>ColumnElement</code>객체의 일부인 <code>ScalarSelect</code>를 사용하는 방면 일반 서브 쿼리는<code>FromClause</code>객체에 있는 <code>Subquery</code>를 사용합니다.</p> <p>스칼라 서브쿼리는 앞에서 설명했던 <a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist/blob/feature/tutorial/5.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%ED%95%B8%EB%93%A4%EB%A7%81%ED%95%98%EA%B8%B0%20-%20Select%EA%B5%AC%EB%AC%B8.md#%EA%B7%B8%EB%A3%B9%ED%95%A8%EC%88%98--group-by-having" target="_blank" rel="noopener noreferrer">그룹 합수<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>와 같이 쓰이고는 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Select.scalar_subquery()를 이용해 구현한 스칼라 서브 쿼리</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             scalar_subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>subq<span class="token punctuation">)</span> <span class="token comment">#ScalarSelect객체</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
(SELECT count(address.id) AS count_1
FROM address, user_account
WHERE user_account.id = address.user_id)
&quot;&quot;&quot;</span>
</code></pre></div><p>스칼라 서브 쿼리가 <code>user_account</code>와 <code>address</code>를 FROM절에서 렌더링하지만
메인쿼리에 있는 <code>user_account</code>테이블이 있어서
스칼라 서브 쿼리에서는 <code>user_account</code> 테이블을 렌더링하지 않습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> subq<span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;address_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.name, (SELECT count(address.id) AS count_1
FROM address
WHERE user_account.id = address.user_id) AS address_count
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>한편 상호 연관 쿼리를 작성 할 때 테이블 간의 연결이 모호해질 수도 있습니다.</p> <blockquote><p>튜토리얼에 나와있는 상호 연관쿼리 예제는 제가 이해하지 못했습니다.
잘 아시는분은 이문서에 기여 부탁드립니다.</p></blockquote> <br> <h2 id="union-union-all-연산자들"><a href="#union-union-all-연산자들" class="header-anchor">#</a> UNION, UNION ALL 연산자들</h2> <p>SQL에서는 <code>UNION</code>, <code>UNION ALL</code>등으로 두 개의 <code>SELECT</code>문을 합치는 것을 의미합니다.<br>
아래와 같이 쿼리문을 실행 할 수도 있습니다.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> user_account
<span class="token keyword">union</span> 
<span class="token keyword">SELECT</span> email_address <span class="token keyword">FROM</span> address
</code></pre></div><p>그 외에도 집합 연산인 <code>INTERSECT</code>(교집합), <code>EXCEPT</code>(차집합)도  SQL에서 지원합니다.<br>
SQLAlchemy에서 <code>Select</code> 객체에 대하여 <code>union()</code>, <code>intersect()</code>, <code>except_()</code> 혹은
<code>union_all()</code>, <code>intersect_all()</code>, <code>except_all()</code>을 지원합니다.</p> <p>이러한 함수들의 반환 값은 <code>CompoundSelect</code>인데 <code>Select</code>와 비슷하게 쓰일 수 있는 객체이지만 더 적은 메서드를 갖고 있습니다.<br> <code>union_all()</code>의 반환값 <code>CompoundSelect</code>객체는 <code>Connection.execute()</code>로 실행될 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> union_all
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt1 <span class="token operator">=</span> select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'sandy'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt2 <span class="token operator">=</span> select<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> union_all<span class="token punctuation">(</span>stmt1<span class="token punctuation">,</span> stmt2<span class="token punctuation">)</span> <span class="token comment">#u는 CompoundSelect 객체입니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'Sandy Cheeks'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'Spongebob Squarepants'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p><code>Subquery</code>객체를 만들기 위해 <code>Select</code>가 <code>SelectBase.subquery()</code>메서드를 제공하는 것처럼
<code>CompoundSelect</code>객체를 서브 쿼리로 비슷한 방식으로 사용 할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u_subq <span class="token operator">=</span> u<span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>u_subq<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>address_table<span class="token punctuation">,</span> u_subq<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     order_by<span class="token punctuation">(</span>u_subq<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span><span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h2 id="exists-서브쿼리들"><a href="#exists-서브쿼리들" class="header-anchor">#</a> EXISTS 서브쿼리들</h2> <p>SQLAlchemy는 <code>SelectBase.exists()</code>메서드를 통해 <code>Exists</code>객체를 만들어 <code>EXISTS</code> 구문을 구현합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># subq는 Exists객체입니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     group_by<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     having<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>subq<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
EXISTS (SELECT count(address.id) AS count_1 
FROM address, user_account 
WHERE user_account.id = address.user_id GROUP BY address.user_id 
HAVING count(address.id) &gt; :count_2)
&quot;&quot;&quot;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>subq<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>한편 <code>EXISTS</code> 구문은 부정으로 사용되지 않는 경우가 더 많습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 이메일 주소가 없는 유저네임을 선택하는 쿼리문입니다.</span>
<span class="token comment"># &quot;~&quot; 연산이 들어간 부분을 확인해보세요</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> subq <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token operator">~</span>subq<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT user_account.id 
FROM user_account 
WHERE NOT (EXISTS (SELECT count(address.id) AS count_1 
FROM address 
WHERE user_account.id = address.user_id GROUP BY address.user_id 
HAVING count(address.id) &gt; :count_2))
&quot;&quot;&quot;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'patrick'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h2 id="sql-함수-다뤄보기"><a href="#sql-함수-다뤄보기" class="header-anchor">#</a> SQL 함수 다뤄보기</h2> <p>이 섹션 앞부분의 <a href="">그룹함수 :GROUP BY, HAVING</a>에서 처음 소개된 <code>func</code> 객체는
새로운 <code>Function</code> 객체를 생성하기 위한 팩토리 역할을 합니다.<br> <code>select()</code>와 같은 구문을 사용 할때는 인자 값으로 <code>func</code>객체로 생성된 SQL함수를 받을 수 있습니다.</p> <ul><li><code>count()</code> : 집계함수로 행의 개수를 출력하는데 사용됩니다.<div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># cnt는 &lt;class 'sqlalchemy.sql.functions.count'&gt;타입입니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> cnt <span class="token operator">=</span> func<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT count(*) AS count_1FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div></li> <li><code>lower()</code> : 문자열 함수로 문자열을 소문자로 바꿔줍니다.<div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token string">&quot;A String With Much UPPERCASE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT lower(:lower_2) AS lower_1
&quot;&quot;&quot;</span>
</code></pre></div></li> <li><code>now()</code> : 현재 시간과 날짜를 반환해주는 함수입니다.
이 함수는 굉장히 흔하게 사용되는 함수이기에 SQLAlchemy는 서로 다른 백엔드에서 손쉽게 렌더링 할 수 있도록 도와줍니다.<div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div></li></ul> <p>다양한 데이터베이스 백엔드에서는 서로 다른 이름의 SQL함수를 갖고 있습니다.<br>
따라서 <code>func</code> 는 가능한 자유롭게 어떤 이름이든 <code>func</code>의 네임스페이스에 접근 할 수 있도록 허용합니다. 그리고  그 이름을 자동으로 SQL 함수로 받아들여 렌더링 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># crazy_function의 데이터 타입은 Function입니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> crazy_function <span class="token operator">=</span> func<span class="token punctuation">.</span>some_crazy_function<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>crazy_function<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT some_crazy_function(user_account.name, :some_crazy_function_2) AS some_crazy_function_1
FROM user_account
&quot;&quot;&quot;</span>
</code></pre></div><p>한편 SQLAlchemy에서는 SQL에서 일반적으로 자주 쓰이는  <code>count</code>, <code>now</code>, <code>max</code> , <code>concat</code>같은 SQL 함수를 백엔드별로 적절한 데이터 타입을 제공합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects <span class="token keyword">import</span> postgresql
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>dialect<span class="token operator">=</span>postgresql<span class="token punctuation">.</span>dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT now() AS now_1
&quot;&quot;&quot;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects <span class="token keyword">import</span> oracle
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>dialect<span class="token operator">=</span>oracle<span class="token punctuation">.</span>dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT CURRENT_TIMESTAMP AS now_1 FROM DUAL
&quot;&quot;&quot;</span>
</code></pre></div><br> <h3 id="functions-have-return-types"><a href="#functions-have-return-types" class="header-anchor">#</a> Functions Have Return Types</h3> <blockquote><p>원문의 Functions Have Return Types 부분은 제가 이해하지 못했습니다.
이에 대해 이해하신 분 있으시다면 이 부분에 기여 부탁드립니다. 감사합니다.</p></blockquote> <br> <h3 id="built-in-functions-have-pre-configured-return-types"><a href="#built-in-functions-have-pre-configured-return-types" class="header-anchor">#</a> Built-in Functions Have Pre-Configured Return Types</h3> <blockquote><p>원문의 Built-in Functions Have Pre-Configured Return Types 부분은 제가 이해하지 못했습니다.
이에 대해 이해하신 분 있으시다면 이 부분에 기여 부탁드립니다. 감사합니다.</p></blockquote> <br> <h3 id="윈도우-함수"><a href="#윈도우-함수" class="header-anchor">#</a> 윈도우 함수</h3> <p>윈도우 함수는 GROUP BY와 비슷한 함수이고 행간의 관계를 쉽게 정의 하기 위해 만든 함수입니다.<br>
윈도우 함수에 대해 알고 싶으신 분들은 <a href="https://mizykk.tistory.com/121" target="_blank" rel="noopener noreferrer">민지님 블로그<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에 자세한 설명이 나와있으니 한 번 읽어보시고 아래의 내용들을 이어서 읽어주세요.</p> <p>SQLAlchemy에서는, <code>func</code> 네임스페이스에 의해 생성된 모든 SQL 함수  중 하나로
OVER 구문을 구현하는  <code>FunctionElement.over()</code> 메서드가 있습니다.</p> <p>윈도우 함수 중 하나로 행의 개수를 세는 <code>row_number()</code> 함수가 있습니다.<br>
각 행을 사용자 이름대로 그룹을 나누고 그 안에서 이메일 주소에 번호를 매길 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># FunctionElement.over.partition_by파라미터를 사용하여 </span>
<span class="token comment"># PARTITION BY 절이 OVER 절에 렌더링되도록 했습니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>partition_by<span class="token operator">=</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
 <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p><code>FunctionElement.over.order_by</code>를 사용하여 <code>ORDER BY</code> 절을 사용할 수도 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>order_by<span class="token operator">=</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'sandy@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
 <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'sandy@squirrelpower.org'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
 <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">,</span> <span class="token string">'spongebob@sqlalchemy.org'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h3 id="within-group-filter등-특수한-지정자"><a href="#within-group-filter등-특수한-지정자" class="header-anchor">#</a> WITHIN GROUP, FILTER등 특수한 지정자</h3> <p><code>WITHIN GORUP</code>이라는 SQL 구문은 순서 집합 또는 가상 집합 그리고 집계함수와 함께 쓰입니다.
일반적인 순서 집합 함수는 <code>percentile_cont()</code> 그리고 <code>rank()</code>를 포함하고 있습니다.
SQLAlchemy에서는 <code>rank</code>, <code>dense_rank</code>, <code>percentile_count</code>, <code>percentile_disc</code>가 구현되어 있고
각각은 <code>FunctionElement.within_group()</code>메서드를 갖고 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>unnest<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         func<span class="token punctuation">.</span>percentile_disc<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>within_group<span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
unnest(percentile_disc(:percentile_disc_1) WITHIN GROUP (ORDER BY user_account.name))
&quot;&quot;&quot;</span>
</code></pre></div><p>어떤 백엔드에서는 &quot;FILTER&quot;를 지원하는데 이는 <code>FunctionElement.filter()</code>메서드로 사용이 가능합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'sandy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>address_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user_table<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>user_table<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>address_table<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     result <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT count(address.email_address) FILTER (WHERE user_account.name = ?) AS anon_1,
count(address.email_address) FILTER (WHERE user_account.name = ?) AS anon_2
FROM user_account JOIN address ON user_account.id = address.user_id
&quot;&quot;&quot;</span>

<span class="token punctuation">(</span><span class="token string">'sandy'</span><span class="token punctuation">,</span> <span class="token string">'spongebob'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <h3 id="table-valued-functions"><a href="#table-valued-functions" class="header-anchor">#</a> Table-Valued Functions</h3> <blockquote><p>원문의 Table-Valued Functions 부분은 제가 이해하지 못했습니다.
이에 대해 이해하신 분 있으시다면 이 부분에 기여 부탁드립니다. 감사합니다.</p></blockquote> <br> <h3 id="컬럼값-함수-또는-스칼라-컬럼-테이블값-함수"><a href="#컬럼값-함수-또는-스칼라-컬럼-테이블값-함수" class="header-anchor">#</a> 컬럼값 함수 또는 스칼라 컬럼(테이블값 함수)</h3> <p>Oracle과 PostgresSQL에서 지원하는 특별 문법 중 하나로 FROM절에 세팅되는 함수들이 있습니다.<br>
PostgreSQL에서는 <code>json_array_elements()</code>, <code>json_object_keys()</code>, <code>json_each_text()</code>, <code>json_each()</code>등의 함수가 그 예입니다.</p> <p>SQLAlchemy는 이러한 함수를 컬럼 값이라고 하며 <code>Function</code>객체에 지정자로 <code>FunctionElement.column_valued()</code>로 적용하여 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select<span class="token punctuation">,</span> func
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>json_array_elements<span class="token punctuation">(</span><span class="token string">'[&quot;one&quot;, &quot;two&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>column_valued<span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT x
FROM json_array_elements(:json_array_elements_1) AS x
&quot;&quot;&quot;</span>
</code></pre></div><p>컬럼값 함수는 오라클에서도 아래와 같이 커스텀 SQL 함수로 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects <span class="token keyword">import</span> oracle
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>func<span class="token punctuation">.</span>scalar_strings<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>column_valued<span class="token punctuation">(</span><span class="token string">&quot;s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>dialect<span class="token operator">=</span>oracle<span class="token punctuation">.</span>dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
SELECT COLUMN_VALUE s
FROM TABLE (scalar_strings(:scalar_strings_1)) s
&quot;&quot;&quot;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqlalchemy-for-pythonist/tutorial/4. 데이터베이스 메타데이터로 작업하기.html" class="prev">
        데이터베이스 메타데이터로 작업하기
      </a></span> <span class="next"><a href="/sqlalchemy-for-pythonist/tutorial/5.2. Core 방식으로 행 삽입하기.html">
        Core 방식으로 행 삽입하기
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/26.a287ef6a.js" defer></script>
  </body>
</html>
