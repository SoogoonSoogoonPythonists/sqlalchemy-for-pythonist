<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ORM으로 관련 개체 작업하기 | 파이썬 개발자를 위한 SQLAlchemy</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-SNPCYHY4R2"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SNPCYHY4R2');</script>
    <meta name="description" content="SQLAlchemy를 쉽게 정리해놓은 문서입니다.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="google-site-verification" content="wjX_mSoZBgO9SZMvjr96yOjo6n3_7pS8xNdmzDl1ESw">
    
    <link rel="preload" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css" as="style"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" as="script"><link rel="preload" href="/sqlalchemy-for-pythonist/assets/js/30.b93101cb.js" as="script"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/10.e7fb4c80.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/11.051ae6e1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/12.7b93e986.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/13.8d014a70.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/14.138cd924.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/15.dca0d300.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/16.69771a0f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/17.66ba2d35.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/18.760e3a59.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/19.7b4a8a4e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/20.adec2767.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/21.c59b443d.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/22.f84628fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/23.2c4a7cf3.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/24.7785bb30.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/25.dc95a31e.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/26.a287ef6a.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/27.a111ddcb.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/28.b809fce0.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/29.7029d8fa.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/3.2e213720.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/31.363734c1.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/4.51c0545f.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/5.220df36c.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/6.345e52dd.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/7.a15a95f4.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/8.006f2d84.js"><link rel="prefetch" href="/sqlalchemy-for-pythonist/assets/js/9.7948c093.js">
    <link rel="stylesheet" href="/sqlalchemy-for-pythonist/assets/css/0.styles.177fd922.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqlalchemy-for-pythonist/" class="home-link router-link-active"><!----> <span class="site-name">파이썬 개발자를 위한 SQLAlchemy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/SoogoonSoogoonPythonists/sqlalchemy-for-pythonist" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html" class="nav-link">
  ko
</a></li><li class="dropdown-item"><!----> <a href="/sqlalchemy-for-pythonist/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/sqlalchemy-for-pythonist/tutorial/" class="sidebar-heading clickable router-link-active open"><span>Tutorial</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/sqlalchemy-for-pythonist/tutorial/1. 튜토리얼 개요.html" class="sidebar-link">튜토리얼 개요</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/2. 연결 설정하기.html" class="sidebar-link">연결 설정하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/3. 트랜잭션과 쿼리 실행하기.html" class="sidebar-link">트랜잭션과 쿼리 실행하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/4. 데이터베이스 메타데이터로 작업하기.html" class="sidebar-link">데이터베이스 메타데이터로 작업하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.1. Core와 ORM 방식으로 행 조회하기.html" class="sidebar-link">Core와 ORM 방식으로 행 조회하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.2. Core 방식으로 행 삽입하기.html" class="sidebar-link">Core 방식으로 행 삽입하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/5.3. Core 방식으로 행 수정 및 삭제하기.html" class="sidebar-link">Core 방식으로 행 수정 및 삭제하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/6. ORM 방식으로 데이터 조작하기.html" class="sidebar-link">ORM 방식으로 데이터 조작하기</a></li><li><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html" class="active sidebar-link">ORM으로 관련 개체 작업하기</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html#관계된-객체-사용하기" class="sidebar-link">관계된 객체 사용하기</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html#session에-객체-캐스케이딩" class="sidebar-link">Session에 객체 캐스케이딩</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html#관계-로드" class="sidebar-link">관계 로드</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html#쿼리에서-relationship-사용하기" class="sidebar-link">쿼리에서 relationship 사용하기</a></li><li class="sidebar-sub-header"><a href="/sqlalchemy-for-pythonist/tutorial/7. ORM 방식으로 관련 개체 작업하기.html#loading-relationshiop의-종류" class="sidebar-link">Loading relationshiop의 종류</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="orm으로-관련-개체-작업하기"><a href="#orm으로-관련-개체-작업하기" class="header-anchor">#</a> ORM으로 관련 개체 작업하기</h1> <br> <p>이번 챕터에서는 다른 객체를 참조하는 매핑된 객체와 상호작용하는 방식인 또 하나의 필수적인 ORM 개념을 다룰 것입니다.<br> <code>relationship()</code>은 매핑된 두 객체 간의 관계를 정의하며, <strong>자기 참조</strong>관계라고도 합니다.<br>
기본적인 구조를 위해 <code>Column</code> 매핑 및 기타 지시문을 생략하고 짧은 형식으로 <code>relationship()</code>을 설명드리겠습니다.</p> <br> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    <span class="token comment"># ... Column mappings</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>

    <span class="token comment"># ... Column mappings</span>

    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;addresses&quot;</span><span class="token punctuation">)</span>
</code></pre></div><br> <p>위 구조를 보면 <code>User</code> 객체에는 <code>addresses</code> 변수, <code>Address</code> 객체에는 <code>user</code> 라는 변수가 있습니다.<br>
공통적으로 <code>relationship</code> 객체로 생성되어져 있는 것을 볼 수 있습니다.
이는 실제 <strong>데이터베이스에 컬럼</strong>으로 존재하는 변수는 아니지만 코드 상에서 쉽게 접근할 수 있도록 하기 위해 설정 되었습니다.<br>
즉, <code>User</code> 객체에서 <code>Address</code> 객체로 쉽게 찾아갈 수 있게 해줍니다.</p> <p>또한 <code>relationship</code> 선언시 파라미터로 <code>back_populates</code> 항목은 반대의 상황 즉,
<code>Address</code> 객체에서 <code>User</code> 객체를 찾아 갈 수 있게 해줍니다.</p> <blockquote><p>관계형으로 보았을 경우 1 : N 관계를 자연스럽게 N : 1 관계로 해주는 설정입니다.</p></blockquote> <p>다음 섹션에서 <code>relationship()</code> 객체의 인스턴스가 어떤 역할을 하는지, 동작하는지 보겠습니다.</p> <br> <h2 id="관계된-객체-사용하기"><a href="#관계된-객체-사용하기" class="header-anchor">#</a> 관계된 객체 사용하기</h2> <br> <p>새로운 <code>User</code> 객체를 만들면 <code>.addresses</code> 컬렉션이 나타나는데 <code>List</code> 객체임을 알 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>    
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p><code>list.append()</code>를 사용하여 <code>Address</code> 객체를 추가할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1 <span class="token operator">=</span> Address<span class="token punctuation">(</span>email_address<span class="token operator">=</span><span class="token string">&quot;pear1.krabs@gmail.com&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a1<span class="token punctuation">)</span>

<span class="token comment"># u1.addresses 컬렉션에 새로운 Address 객체가 포함되었습니다.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p><code>Address</code> 객체를 인스턴스 <code>User.addresses</code> 컬렉션과 연관시켰다면 변수 <code>u1</code> 에는 또 다른 동작이 발생하는데,<br> <code>User.addresses</code> 와 <code>Address.user</code> 관계가 동기화 되어</p> <ul><li><code>User</code> 객체에서 <code>Address</code> 이동할 수 있을 뿐만 아니라</li> <li><code>Address</code> 객체에서 다시 <code>User</code> 객체로 이동할 수도 있습니다.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1<span class="token punctuation">.</span>user
User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>
</code></pre></div><p>두개의 <code>relationshiop()</code> 객체 간의 <code>relationship.back_populates</code> 을 사용한 동기화 결과입니다.</p> <p>매개변수 <code>relationshiop()</code> 는 보완적으로 할당/목록 변형이 발생할때 다른 변수로 지정할 수 있습니다.
다른 <code>Address</code> 객체를 생성하고 해당 <code>Address.user</code> 속성에 할당하면 해당 객체 <code>Address</code>에 대한 <code>User.addresses</code> 컬렉션의 일부가 되는것도 확인 할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2 <span class="token operator">=</span> Address<span class="token punctuation">(</span>email_address<span class="token operator">=</span><span class="token string">&quot;pearl@aol.com&quot;</span><span class="token punctuation">,</span> user<span class="token operator">=</span>u1<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><br> <p>우리는 실제로 객체(<code>Address</code>)에 선언된 속성처럼 <code>user</code>의 키워드 인수로 <code>u1</code> 변수를 사용했습니다.<br>
다음 사실 이후에 속성을 할당하는 것과 같습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># equivalent effect as a2 = Address(user=u1)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2<span class="token punctuation">.</span>user <span class="token operator">=</span> u1
</code></pre></div><br> <h2 id="session에-객체-캐스케이딩"><a href="#session에-객체-캐스케이딩" class="header-anchor">#</a> <code>Session</code>에 객체 캐스케이딩</h2> <br> <p>이제 메모리의 양방향 구조와 연결된 두 개의 <code>User</code>, <code>Address</code> 객체가 있지만 이전에 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/6. ORM으로 데이터 조작하기.html#orm으로-행-삽입하기)">ORM으로 행 삽입하기</a> 에서 언급했듯이 이러한 객체는 객체와 연결될 때까지 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/glossary.html#term-transient)">일시적인</a> <code>Session</code> 상태에 있습니다.</p> <p>우리는 <code>Session.add()</code> 를 사용하고, <code>User</code> 객체에 메서드를 적용할 때 관련 <code>Address</code> 객체도 추가된다는 점을 확인해 볼 필요가 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u1<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1 <span class="token keyword">in</span> session
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1 <span class="token keyword">in</span> session
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2 <span class="token keyword">in</span> session 
<span class="token boolean">True</span>
</code></pre></div><p>세 개의 객체는 이제 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/glossary.html#term-pending)">보류</a> 상태에 있으며, 이는 INSERT 작업이 진행되지 않았음을 의미합니다.<br>
세 객체는 모두 기본 키가 할당되지 않았으며, 또한 a1 및 a2 객체에는 열(<code>user_id</code>)을 참조 속성이 있습니다.<br>
이는 객체가 아직 실제 데이터베이스 연결되지 않았기 때문입니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>u1<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token boolean">None</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token boolean">None</span>
</code></pre></div><p>데이터베이스에 저장해봅시다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>구현한 코드를 SQL 쿼리로 동작을 해본다면 이와 같습니다.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_account <span class="token punctuation">(</span>name<span class="token punctuation">,</span> fullname<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span> <span class="token string">'Pearl Krabs'</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> address <span class="token punctuation">(</span>email_address<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> address <span class="token punctuation">(</span>email_address<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">COMMIT</span>
</code></pre></div><p><code>session</code>을 사용하여 SQL의 INSERT, UPDATE, DELETE 문을 자동화할 수 있습니다.
마지막으로 <code>Session.commit()</code>을 실행하여 모든 단계를 올바른 순서로 호출되며 <code>user_account</code>에 <code>address.user_id</code> 기본키가 적용됩니다.</p> <br> <h2 id="관계-로드"><a href="#관계-로드" class="header-anchor">#</a> 관계 로드</h2> <br> <p><code>Session.commit()</code> 을 호출한 이후에는 <code>u1</code> 객체에 생성된 기본 키를 볼 수 있게됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">6</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">BEGIN</span> <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id <span class="token keyword">AS</span> user_account_id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name <span class="token keyword">AS</span> user_account_name<span class="token punctuation">,</span>
user_account<span class="token punctuation">.</span>fullname <span class="token keyword">AS</span> user_account_fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> ?
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>다음처럼 <code>u1.addresses</code> 에 연결된 객체들에도 <code>id</code>가 들어와있는 것을 볼 수 있습니다.
해당 객체를 검색하기 위해 우리는 <strong>lazy load</strong> 방식으로 볼 수 있습니다.</p> <blockquote><p>lazy loading : 누군가 해당 정보에 접근하고자 할때 그때 SELECT문을 날려서 정보를 충당하는 방식. 즉, 그때그때 필요한 정보만 가져오는 것입니다.</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> ? <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>SQLAlchemy ORM의 기본 컬렉션 및 관련 특성은 <strong>lazy loading</strong> 입니다. 즉, 한번 <code>relationship</code> 된 컬렉션은 데이터가 메모리에 존재하는 한 계속 접근을 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u1<span class="token punctuation">.</span>addresses
<span class="token punctuation">[</span>Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>lazy loading은 최적화를 위한 명시적인 단계를 수행하지 않으면 비용이 많이 들 수 있지만, 적어도 lazy loading은 중복 작업을 수행하지 않도록 최적화되어 있습니다.</p> <p><code>u1.addresses</code>의 컬렉션에 <code>a1</code> 및 <code>a2</code> 객체들 또한 볼 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a1
Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a2
Address<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">)</span>
</code></pre></div><p><code>relationship</code> 개념에 대한 추가 소개는 이 섹션의 후반부에 더 설명드리겠습니다.</p> <br> <h2 id="쿼리에서-relationship-사용하기"><a href="#쿼리에서-relationship-사용하기" class="header-anchor">#</a> 쿼리에서 <code>relationship</code> 사용하기</h2> <br> <p>이 섹션에서는 <code>relationship()</code> 이 SQL 쿼리 구성을 자동화하는데 도움이 되는 여러 가지 방법을 소개합니다.</p> <br> <h3 id="relationship-을-사용하여-조인하기"><a href="#relationship-을-사용하여-조인하기" class="header-anchor">#</a> <code>relationship()</code>을 사용하여 조인하기</h3> <p><a href="/sqlalchemy-for-pythonist/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#from절과-join-명시하기)">FROM절과 JOIN명시하기</a> 및 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#where절)">WHERE절</a> 섹션에서는 <code>Select.join()</code> 및 <code>Select.join_from()</code> 메서드를 사용하여 SQL JOIN을 구성하였습니다.<br>
테이블간에 조인하는 방법을 설명하기 위해 이러한 메서드는 두 테이블을 연결하는 <code>ForeignKeyConstraint</code> 객체가 있는지 여부에 따라 ON 절을 유추하거나 특정 ON 절을 나타내는 SQL Expression 구문을 제공 할 수 있습니다.</p> <p><code>relationship()</code> 객체를 사용하여 join의 ON 절을 설정할 수 있습니다.
<code>relationship()</code> 에 해당하는 객체는 <code>Select.join()</code>의 <strong>단일 인수</strong>로 전달될 수 있으며,
right join과 ON 절을 동시에 나타내는 역할을 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select_from<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> user_account <span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><p>매핑된 <code>relationship()</code>있는 경우 <code>Select.join()</code> 또는 <code>Select.join_from()</code> 지정하지 않을 경우 <strong>ON 절은 사용되지 않습니다.</strong><br>
즉, <code>user</code> 및 <code>Address</code> 객체의 <code>relationship()</code> 객체가 아니라 매핑된 두 테이블 객체 간의 <code>ForeignKeyConstraint</code>로 인해 작동합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> Address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> user_account <span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h3 id="별칭-aliased-을-사용하여-조인하기"><a href="#별칭-aliased-을-사용하여-조인하기" class="header-anchor">#</a> 별칭(aliased)을 사용하여 조인하기</h3> <p><code>relationship()</code>을 사용하여 SQL JOIN을 구성하는 경우 [<code>PropComparator.of_type()</code>] 사용하여 조인 대상이 <code>aliased()</code>이 되는 사용 사례가 적합합니다. 그러나 <code>relationship()</code>를 사용하여 [<code>ORM Entity Aliases</code>]에 설명된 것과 동일한 조인을 구성합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> aliased
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_alias_1 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> address_alias_2 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_1<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_1<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@aol.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join_from<span class="token punctuation">(</span>User<span class="token punctuation">,</span> address_alias_2<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     where<span class="token punctuation">(</span>address_alias_2<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'patrick@gmail.com'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">JOIN</span> address <span class="token keyword">AS</span> address_1 <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address_1<span class="token punctuation">.</span>user_id
<span class="token keyword">JOIN</span> address <span class="token keyword">AS</span> address_2 <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address_2<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> address_1<span class="token punctuation">.</span>email_address <span class="token operator">=</span> :email_address_1
<span class="token operator">AND</span> address_2<span class="token punctuation">.</span>email_address <span class="token operator">=</span> :email_address_2
</code></pre></div><p><code>relationship()</code>을 사용하여 <code>aliased()</code>에서 조인을 직접 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> user_alias_1 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     select<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     join<span class="token punctuation">(</span>user_alias_1<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account_1<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span> user_account <span class="token keyword">AS</span> user_account_1
<span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h3 id="on-조건-확대"><a href="#on-조건-확대" class="header-anchor">#</a> ON 조건 확대</h3> <p><code>relation()</code>으로 생성된 ON 절에 조건을 추가할 수 있습니다. 이 기능은 관계된 경로에 대한 특정 조인의 범위를 신속하게 제한하는 방법뿐만 아니라 마지막 섹션에서 소개하는 로더 전략 구성과 같은 사용 사례에도 유용합니다.<br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/internals.html#sqlalchemy.orm.PropComparator.and_)"><code>PropComparator.and_()</code></a> 메서드는 AND를 통해 JOIN의 ON 절에 결합되는 일련의 SQL 식을 위치적으로 허용합니다.  예를 들어,<br> <code>User</code> 및 <code>Address</code>을 활용하여 ON 기준을 특정 이메일 주소로만 제한하려는 경우 이와 같습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>and_<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">JOIN</span> address <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> address<span class="token punctuation">.</span>email_address <span class="token operator">=</span> ?
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="exists-has-and"><a href="#exists-has-and" class="header-anchor">#</a> EXISTS has() , and()</h3> <p><a href="/sqlalchemy-for-pythonist/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#exists-서브쿼리들)">EXISTS 서브쿼리들</a> 섹션에서는 SQL EXISTS 키워드를 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/5. 데이터 핸들링 - Core, ORM으로 행 조회하기.html#스칼라-서브-쿼리-상호연관-쿼리)">스칼라 서브 쿼리, 상호연관 쿼리</a> 섹션과 함께 소개했습니다.<br> <code>relationship()</code> 은 관계 측면에서 공통적으로 서브쿼리를 생성하는데 사용할 수 있는 일부 도움을 제공합니다.</p> <br> <p><code>User.addresses</code>와 같은 1:N (one-to-many) 관계의 경우 <code>PropComparator.any()</code>를 사용하여 <code>user_account</code>테이블과 다시 연결되는 주소 테이블에 서브쿼리를 생성할 수 있습니다. 이 메서드는 하위 쿼리와 일치하는 행을 제한하는 선택적 WHERE 기준을 허용합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Pearl Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> address<span class="token punctuation">.</span>email_address <span class="token operator">=</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>이와 반대로 관련된 데이터가 없는 객체를 찾는 것은 <code>~User.addresses.any()</code>을 사용하여 <code>User</code> 객체에 검색하는 방법입니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span><span class="token operator">~</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Patrick McStar'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Squidward Tentacles'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Eugene H. Krabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> <span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p><code>PropComparator.has()</code> 메서드는 <code>PropComparator.any()</code>와 비슷한 방식으로 작동하지만, N:1 (Many-to-one) 관계에 사용됩니다.<br>
예시로 &quot;pearl&quot;에 속하는 모든 <code>Address</code> 객체를 찾으려는 경우 이와 같습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>has<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">&quot;pkrabs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'pearl.krabs@gmail.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'pearl@aol.com'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="관계-연산자"><a href="#관계-연산자" class="header-anchor">#</a> 관계 연산자</h3> <p><code>relationship()</code>와 함께 제공되는 SQL 생성 도우미에는 다음과 같은 몇 가지 종류가 있습니다.</p> <ul><li>N : 1 (Many-to-one) 비교<br>
특정 객체 인스턴스를 N : 1 관계와 비교하여 대상 엔티티의 외부 키가 지정된 객체의 기본 키값과 일치하는 행을 선택할 수 있습니다.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user <span class="token operator">==</span> u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> :param_1 <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><ul><li>NOT N : 1 (Many-to-one) 비교<br>
같지 않은 연산자(!=)를 사용할 수 있습니다.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user <span class="token operator">!=</span> u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">!=</span> :user_id_1 <span class="token operator">OR</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IS</span> <span class="token boolean">NULL</span>
</code></pre></div><ul><li>객체가 1 : N (one-to-many) 컬렉션에 포함되어있는지 확인하는 방법입니다.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> :param_1
</code></pre></div><ul><li>객체가 1 : N 관계에서 특정 상위 항목에 있는지 확인하는 방법입니다.<br> <code>with_parent()</code>은 주어진 상위 항목이 참조하는 행을 반환하는 비교를 생성합니다. 이는 == 연산자를 사용하는 것과 동일합니다.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> with_parent
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>with_parent<span class="token punctuation">(</span>u1<span class="token punctuation">,</span> User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> :param_1 <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre></div><br> <h2 id="loading-relationshiop의-종류"><a href="#loading-relationshiop의-종류" class="header-anchor">#</a> Loading relationshiop의 종류</h2> <br> <p><a href="#%EA%B4%80%EA%B3%84-%EB%A1%9C%EB%93%9C"><code>관계 로드</code></a> 섹션에서는 매핑된 객체 인스턴스로 작업할 때 <code>relationship()</code>을 사용하여 매핑된 특성에 엑세스하면 이 컬렉션에 있어야 하는 객체를 로드하며, 컬렉션이 채워지지 않은 경우 <code>lazy load</code>가 발생한다는 개념을 도입했습니다.</p> <p>Lazy loading 방식은 가장 유명한 ORM 패턴 중 하나이며, 가장 논란이 많은 ORM 패턴이기도 합니다.<br>
메모리에 있는 수십개의 ORM 객체가 각각 소수의 언로드 속성을 참조하는 경우, 객체의 일상적인 조작은 누적이 될 수 있는 많은 문제(<a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/glossary.html#term-N-plus-one-problem)"><code>N+1 Problem</code></a>)를 암묵적으로 방출될 수 있습니다. 이러한 암시적 쿼리는 더 이상 사용할 수 없는 데이터베이스 변환을 시도할 때 또는 비동기화 같은 대체 동시성 패턴을 사용할 때 실제로 전혀 작동하지 않을 수 있습니다.</p> <blockquote><p><a href="(https://blog.naver.com/yysdntjq/222405755893)"><code>N + 1 Problem</code></a>이란?<br>
쿼리 1번으로 N건의 데이터를 가져왔는데 원하는 데이터를 얻기 위해 이 N건의 데이터를 데이터 수 만큼 반복해서 2차적으로 쿼리를 수행하는 문제입니다.</p></blockquote> <p>lazy loading 방식은 사용 중인 동시성 접근법과 호환되고 다른 방법으로 문제를 일으키지 않을 때 매우 인기있고 유용한 패턴입니다. 이러한 이유로 SQLAlchemy의 ORM은 이러한 로드 동작을 제허하고 최적화할 수 있는 기능에 중점을 둡니다.</p> <p>무엇보다 ORM의 lazy loading 방식을 효과적으로 사용하는 첫 번째 단계는 <strong>Application을 테스트하고 SQL을 확인하는 것입니다.</strong><br> <code>Session</code>에서 분리된 객체에 대해 로드가 부적절하게 발생하는 경우, <strong><a href="#loading-relationshiop%EC%9D%98-%EC%A2%85%EB%A5%98"><code>Loading relationship의 종류</code></a></strong> 사용을 검토해야 합니다.</p> <p><code>Select.options()</code> 메서드를 사용하여 SELECT 문과 연결할 수 있는 객체로 표시됩니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> user_obj <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
    select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_obj<span class="token punctuation">.</span>addresses  <span class="token comment"># access addresses collection already loaded</span>
</code></pre></div><p><code>relationship.lazy</code>를 사용하여 <code>relationship()</code>의 기본값으로 구성할 수도 있습니다.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
class <span class="token keyword">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span>:
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;selectin&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>가장 많이 사용되는 loading 방식 몇 가지를 소개합니다.</p> <blockquote><p>참고<br> <strong>관계 로딩 기법의 2가지 기법</strong><br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#relationship-lazy-option)"><code>Configuring Loader Strategies at Mapping Time</code></a> - <code>relationship()</code> 구성에 대한 세부정보<br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#relationship-loader-options)"><code>Relationship Loading with Loader Options</code></a> - 로더에 대한 세부정보</p></blockquote> <br> <h3 id="select-in-loading-방식"><a href="#select-in-loading-방식" class="header-anchor">#</a> Select IN loading 방식</h3> <p>최신 SQLAlchemy에서 가장 유용한 로딩방식 옵션은 <code>selectinload()</code>입니다. 이 옵션은 관련 컬렉션을 참조하는 객체 집합의 문제인 가장 일반적인 형태의 &quot;N + 1 Problem&quot;문제를 해결합니다.<br>
대부분의 경우 JOIN 또는 하위 쿼리를 도입하지 않고 관련 테이블에 대해서만 내보낼 수 있는 SELET 양식을 사용하여 이 작업을 수행합니다. 또한 컬렉션이 로드되지 않은 상위 객체에 대한 쿼리만 수행합니다.<br>
아래 예시는 <code>User</code> 객체와 관련된 <code>Address</code> 객체를 <code>selectinload()</code>하여 보여줍니다.<br> <code>Session.execute()</code> 호출하는 동안 데이터베이스에서는 두 개의 SELECT 문이 생성되고 두 번째는 관련 <code>Address</code> 객체를 가져오는 것입니다.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">select</span><span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token keyword">User</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">session</span><span class="token punctuation">.</span><span class="token keyword">execute</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>:
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">&quot;{row.User.name}  ({', '.join(a.email_address for a in row.User.addresses)})&quot;</span><span class="token punctuation">)</span>
spongebob  <span class="token punctuation">(</span>spongebob<span class="token variable">@sqlalchemy.org</span><span class="token punctuation">)</span>
sandy  <span class="token punctuation">(</span>sandy<span class="token variable">@sqlalchemy.org</span><span class="token punctuation">,</span> sandy<span class="token variable">@squirrelpower.org</span><span class="token punctuation">)</span>
patrick  <span class="token punctuation">(</span><span class="token punctuation">)</span>
squidward  <span class="token punctuation">(</span><span class="token punctuation">)</span>
ehkrabs  <span class="token punctuation">(</span><span class="token punctuation">)</span>
pkrabs  <span class="token punctuation">(</span>pearl<span class="token punctuation">.</span>krabs<span class="token variable">@gmail.com</span><span class="token punctuation">,</span> pearl<span class="token variable">@aol.com</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_account<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
</code></pre></div><br> <h3 id="joined-loading-방식"><a href="#joined-loading-방식" class="header-anchor">#</a> Joined Loading 방식</h3> <p><code>Joined Loading</code>은 SQLAlchemy에서 가장 오래됬으며, 이 방식은 eager loading의 일종으로 <code>joined eager loading</code>이라고도 합니다. N : 1 관계의 객체를 로드하는 데 가장 적합하며,
<code>relationship()</code>에 명시된 테이블을 SELECT JOIN하여 모든 테이블의 데이터들을 한꺼번에 가져오는 방식으로 <code>Address</code> 객체에 연결된 사용자가 있는 다음과 같은 경우에 OUTER JOIN이 아닌 INNER JOIN을 사용할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> joinedload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">,</span> innerjoin<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

spongebob@sqlalchemy<span class="token punctuation">.</span>org spongebob
sandy@sqlalchemy<span class="token punctuation">.</span>org sandy
sandy@squirrelpower<span class="token punctuation">.</span>org sandy
pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com pkrabs
pearl@aol<span class="token punctuation">.</span>com pkrabs
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span>
user_account_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> address
<span class="token keyword">JOIN</span> user_account <span class="token keyword">AS</span> user_account_1 <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><code>joinedload()</code>는 1 : N 관계를 의미하는 컬렉션에도 사용되지만 중접 컬렉션 및 더 큰 컬렉션이므로 <code>selectinload()</code> 처럼 사례별로 평가해야 하는 것과 같은 다른 옵션과 비교 합니다.</p> <p>SELECT 쿼리문의 WHERE 및 ORDER BY 기준은 <strong>joinload()에 의해 렌더링된 테이블을 대상으로 하지 않는다는</strong> 점에 유의하는 것이 중요합니다. 위 SQL 쿼리에서 직접 주소를 지정할 수 없는 *익명 별칭**이 <code>user_account</code>테이블에 적용된 것을 볼 수 있습니다. 이 개념은 <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#zen-of-eager-loading)"><code>Zen of joined Eager Loading</code></a> 섹션에서 더 자세히 설명합니다.</p> <p><code>joinedload()</code>에 의해 ON 절은 이전 <a href="#on-%EC%A1%B0%EA%B1%B4-%ED%99%95%EB%8C%80"><code>ON 조건 확대</code></a>에서 설명한 방법 <code>joinedload()</code>을 사용하여 직접 영향을 받을 수 있습니다.</p> <blockquote><p>참고<br>
일반적인 경우에는 &quot;N + 1 problem&quot;가 훨씬 덜 만연하기 때문에 다대일 열망 로드가 종종 필요하지 않다는 점에 유의하는 것이 중요합니다. 많은 객체가 모두 동일한 관련 객체를 참조하는 경우(예: <code>Address</code> 각각 동일한 참조하는 많은 객체) 일반 지연 로드를 사용하여 <code>User</code>객체에 대해 SQL이 한 번만 내보내 집니다. 지연 로드 루틴은 <code>Session</code>가능한 경우 SQL을 내보내지 않고 현재 기본 키로 관련 객체를 조회 합니다.</p></blockquote> <br> <h3 id="explicit-join-eager-load-방식"><a href="#explicit-join-eager-load-방식" class="header-anchor">#</a> Explicit Join + Eager load 방식</h3> <p>일반적인 사용 사례는 <code>contains_eager()</code>옵션을 사용하며, 이 옵션은 JOIN을 직접 설정했다고 가정하고 대신 COLUMNS 절의 추가 열이 반환된 각 객체의 관련 속성에 로드해야 한다는 점을 제외하고는 <code>joinedload()</code> 와 매우 유사합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> contains_eager

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'pkrabs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>contains_eager<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com pkrabs
pearl@aol<span class="token punctuation">.</span>com pkrabs
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">FROM</span> address <span class="token keyword">JOIN</span> user_account <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> ? <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'pkrabs'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><p>위에서 <code>user_account.name</code>을 필터링하고 <code>user_account</code>의 반환된  <code>Address.user</code>속성으로 로드했습니다.<br> <code>joinedload()</code>를 별도로 적용했다면 불필요하게 두 번 조인된 SQL 쿼리가 생성되었을 것입니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>Address<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   join<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'pkrabs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>Address<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>  <span class="token comment"># SELECT has a JOIN and LEFT OUTER JOIN unnecessarily</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> address<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
user_account_1<span class="token punctuation">.</span>id <span class="token keyword">AS</span> id_1<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account_1<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> address <span class="token keyword">JOIN</span> user_account <span class="token keyword">ON</span> user_account<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> user_account <span class="token keyword">AS</span> user_account_1 <span class="token keyword">ON</span> user_account_1<span class="token punctuation">.</span>id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> user_account<span class="token punctuation">.</span>name <span class="token operator">=</span> :name_1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> address<span class="token punctuation">.</span>id
</code></pre></div><br> <blockquote><p>참고<br> <strong>관계 로딩 기법의 2가지 기법</strong><br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#zen-of-eager-loading)"><code>Zen of joined Eager Loading</code></a> - 해당 로딩 방식에 대한 세부정보<br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#contains-eager)"><code>Routing Explicit Joins/Statements into Eagerly Loaded Collections</code></a> - using <code>contains_eager()</code></p></blockquote> <br> <h3 id="로더-경로-설정"><a href="#로더-경로-설정" class="header-anchor">#</a> 로더 경로 설정</h3> <p><code>PropComparator.and_()</code> 방법은 실제로 대부분의 로더 옵션에서 일반적으로 사용할 수 있습니다.
예를 들어 <code>sqlalchemy.org</code>도메인에서 사용자 이름과 이메일 주소를 다시 로드하려는 경우 <code>selectinload()</code> 전달된 인수에 <code>PropComparator.and_()</code>를 적용하여 다음 조건을 제한할 수 있습니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   options<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       selectinload<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>           User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>and_<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token operator">~</span>Address<span class="token punctuation">.</span>email_address<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;sqlalchemy.org&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>           <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   execution_options<span class="token punctuation">(</span>populate_existing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">.</span>User<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">  (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a<span class="token punctuation">.</span>email_address <span class="token keyword">for</span> a <span class="token keyword">in</span> row<span class="token punctuation">.</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span><span class="token punctuation">)</span>

spongebob  <span class="token punctuation">(</span><span class="token punctuation">)</span>
sandy  <span class="token punctuation">(</span>sandy@squirrelpower<span class="token punctuation">.</span>org<span class="token punctuation">)</span>
patrick  <span class="token punctuation">(</span><span class="token punctuation">)</span>
squidward  <span class="token punctuation">(</span><span class="token punctuation">)</span>
ehkrabs  <span class="token punctuation">(</span><span class="token punctuation">)</span>
pkrabs  <span class="token punctuation">(</span>pearl<span class="token punctuation">.</span>krabs@gmail<span class="token punctuation">.</span>com<span class="token punctuation">,</span> pearl@aol<span class="token punctuation">.</span>com<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>위 코드는 다음 쿼리를 실행하는 것과 같습니다.</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_account<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user_account<span class="token punctuation">.</span>fullname
<span class="token keyword">FROM</span> user_account <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_account<span class="token punctuation">.</span>id
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> address<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> address_user_id<span class="token punctuation">,</span> address<span class="token punctuation">.</span>id <span class="token keyword">AS</span> address_id<span class="token punctuation">,</span>
address<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> address_email_address
<span class="token keyword">FROM</span> address
<span class="token keyword">WHERE</span> address<span class="token punctuation">.</span>user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token operator">AND</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span>email_address <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%'</span> <span class="token operator">||</span> ?<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'sqlalchemy.org'</span><span class="token punctuation">)</span>
</code></pre></div><p>위에서 매우 중요한 점은 <code>.execution_options(populate_existing=True)</code> 옵션이 추가되었다는 점 입니다.<br>
행을 가져올 때 적용되는 이 옵션은 로더 옵션이 이미 로드된 객체의 기존 컬렉션 내용을 대체해야 함을 나타냅니다.<br> <code>Session</code>객체로 반복 작업하므로 위에서 로드되는 객체는 본 튜토리얼의 ORM 섹션 시작 시 처음 유지되었던 것과 동일한 Python 인스턴스입니다.</p> <br> <h3 id="raise-loading-방식"><a href="#raise-loading-방식" class="header-anchor">#</a> raise loading 방식</h3> <p><code>raiseload()</code>옵션은 일반적으로 느린 대신 오류를 발생시켜 N + 1 문제가 발생하는 것을 완전히 차단하는데 사용됩니다.<br>
예로 두 가지 변형 모델이 있습니다. SQL이 필요한 <code>lazy load</code> 와 현재 <code>Session</code>만 참조하면 되는 작업을 포함한 모든 &quot;load&quot; 작업을 차단하는 <code>raiseload.sql_only</code> 옵션입니다.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_account'</span>

    <span class="token comment"># ... Column mappings</span>

    addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Address&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;raise_on_sql&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>

    <span class="token comment"># ... Column mappings</span>

    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">&quot;addresses&quot;</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">&quot;raise_on_sql&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>이러한 매핑을 사용하면 응용 프로그램이 'lazy loading'에 차단되어 특정 쿼리에 로더 전략을 지정해야 합니다.</p> <div class="language-python extra-class"><pre class="language-python"><code>u1 <span class="token operator">=</span> s<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
u1<span class="token punctuation">.</span>addresses
sqlalchemy<span class="token punctuation">.</span>exc<span class="token punctuation">.</span>InvalidRequestError<span class="token punctuation">:</span> <span class="token string">'User.addresses'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> available due to lazy<span class="token operator">=</span><span class="token string">'raise_on_sql'</span>
</code></pre></div><p>예외는 이 컬렉션을 대신 먼저 로드해야 함을 나타냅니다.</p> <div class="language-python extra-class"><pre class="language-python"><code>u1 <span class="token operator">=</span> s<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><code>lazy=&quot;raise_on_sql&quot;</code> 옵션은 N : 1 관계에도 현명하게 시도합니다.<br>
위에서 <code>Address.user</code>속성이 <code>Address</code>에 로드되지 않았지만 해당 <code>User</code> 객체가 동일한 <code>Session</code>에 있는 경우 &quot;raiseload&quot;은 오류를 발생시키지 않습니다.</p> <blockquote><p>참고<br> <a href="/sqlalchemy-for-pythonist/tutorial/(https:/docs.sqlalchemy.org/en/14/orm/loading_relationships.html#prevent-lazy-with-raiseload)"><code>raiseload</code>를 사용하여 원치 않는 lazy loading 방지</a><br> <a href="(https://docs.sqlalchemy.org/en/14/orm/loading_relationships.html)"><code>relatonship</code>에서 lazy loading 방지</a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqlalchemy-for-pythonist/tutorial/6. ORM 방식으로 데이터 조작하기.html" class="prev">
        ORM 방식으로 데이터 조작하기
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqlalchemy-for-pythonist/assets/js/app.8473826e.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/2.98979e96.js" defer></script><script src="/sqlalchemy-for-pythonist/assets/js/30.b93101cb.js" defer></script>
  </body>
</html>
